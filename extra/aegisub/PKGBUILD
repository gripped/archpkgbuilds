# Maintainer: Maxime Gauduin <alucryd@archlinux.org>
# Contributor: kozec <kozec@kozec.com>
# Contributor: Limao Luo <luolimao+AUR@gmail.com>

pkgname=aegisub
pkgver=3.4.0
pkgrel=1
pkgdesc='A general-purpose subtitle editor with ASS/SSA support'
arch=(x86_64)
url=http://www.aegisub.org
license=(BSD-3-Clause)
depends=(
  alsa-lib
  boost-libs
  curl
  fftw
  fontconfig
  gcc-libs
  glibc
  hicolor-icon-theme
  hunspell
  icu
  libass.so
  libffms2.so
  libgl
  libpulse
  uchardet
  wxwidgets-common
  wxwidgets-gtk3
  zlib
)
makedepends=(
  boost
  cmake
  git
  mesa
  meson
)
_tag=b0fc741099f610ee9486bfaf0186d39f74b8d756
source=(git+https://github.com/TypesettingTools/Aegisub.git#tag=${_tag})
#validpgpkeys=(6DD9508BCB1CE31AF295FF9B6A889F50A8B00C08) # Thomas Goyne <plorkyeran@aegisub.org>
b2sums=('879c6418260aea594cf68245c1dc0d7a6c428ec600f3972f548cfaf16595f793366ae189eba55b069736c061168414498ec3f47e20beddc53f09622673bb47c9')

prepare() {
  cd Aegisub
  meson subprojects download luajit
  meson subprojects packagefiles --apply luajit
  sed "/subdir('tests')/d" -i meson.build
}

pkgver() {
  cd Aegisub
  git describe --tags | sed 's/^v//'
}

build() {
  export CXXFLAGS+=" -fpermissive"
  arch-meson Aegisub build \
    -Dopenal=disabled \
    -Dportaudio=disabled
  meson compile -C build
}

package() {
  meson install -C build --destdir "${pkgdir}"
  install -dm 755 "${pkgdir}"/usr/share/aegisub/automation/include
  cp -dr --no-preserve=ownership Aegisub/automation/{autoload,demos} "${pkgdir}"/usr/share/aegisub/automation/
  cp -dr --no-preserve=ownership Aegisub/automation/include/{aegisub,*.lua} "${pkgdir}"/usr/share/aegisub/automation/include/
  install -Dm 644 Aegisub/LICENCE -t "${pkgdir}"/usr/share/licenses/aegisub/
}

# vim: ts=2 sw=2 et:

# Maintainer: Jakub Klinkovsk√Ω <lahwaacz at archlinux dot org>
# Contributor: Specter119 <spcter119 AT gmail.com>

pkgname=jupyter-lsp
pkgver=2.3.0
pkgrel=1
pkgdesc="Multi-Language Server WebSocket proxy for Jupyter Notebook/Lab server."
arch=(any)
url="https://github.com/jupyter-lsp/jupyterlab-lsp"
license=(BSD-3-Clause)
depends=(
  python
  jupyter-server
)
makedepends=(
  python-build
  python-installer
  python-setuptools
  python-wheel
)
checkdepends=(
  python-pytest
  python-pytest-asyncio
  bash-language-server
  jedi-language-server
  pyright
  python-lsp-server
  texlab
  typescript-language-server
  yaml-language-server
)
optdepends=(
  "bash-language-server: Bash language server"
  "jedi-language-server: Jedi language server"
  "pyright: Python type checker"
  "python-lsp-server: Python language server"
  "texlab: LaTeX language server"
  "typescript-language-server: TypeScript language server"
  "vscode-css-languageserver: CSS/LESS/SCSS language server"
  "vscode-html-languageserver: HTML language server"
  "vscode-json-languageserver: JSON language server"
  "yaml-language-server: YAML language server"
)
source=("$url/archive/refs/tags/$pkgname-$pkgver.tar.gz")
b2sums=('83b1b2f143372af12b7e881ea7536f087f6b3690025d8216d566e86ef1361dadbb931edfd2d2d5e6270bce86e3a35f3a8cfb59692b8c440e0145083a376c5911')

build() {
  cd jupyterlab-lsp-$pkgname-$pkgver/python_packages/jupyter_lsp
  python -m build --wheel --no-isolation
}

check(){
  cd jupyterlab-lsp-$pkgname-$pkgver/python_packages/jupyter_lsp
  local deselected_tests=(
    # deselect tests that use unavailable language servers
    "test_detect.py::test_r_package_detection"
    "test_listener.py::test_listeners[dockerfile-language-server-nodejs]"
    "test_listener.py::test_listeners[sql-language-server]"
    "test_listener.py::test_listeners[unified-language-server]"
    "test_session.py::test_start_known[dockerfile-language-server-nodejs]"
    "test_session.py::test_start_known[sql-language-server]"
    "test_session.py::test_start_known[unified-language-server]"
    # these fail probably due to the -bin suffix
    "test_listener.py::test_listeners[vscode-css-languageserver-bin]"
    "test_listener.py::test_listeners[vscode-html-languageserver-bin]"
    "test_listener.py::test_listeners[vscode-json-languageserver-bin]"
    "test_session.py::test_start_known[vscode-css-languageserver-bin]"
    "test_session.py::test_start_known[vscode-html-languageserver-bin]"
    "test_session.py::test_start_known[vscode-json-languageserver-bin]"
    # FIXME: these should not fail
    "test_listener.py::test_listeners[jedi-language-server]"
    "test_listener.py::test_listeners[typescript-language-server]"
    "test_listener.py::test_listeners[yaml-language-server]"
    "test_listener.py::test_listeners[pylsp]" # - assert 2 == 1
    "test_listener.py::test_listeners[texlab]" # - assert 2 ...
  )
  PYTHONPATH="$PWD/build/lib" pytest $(printf -- "--deselect jupyter_lsp/tests/%s " "${deselected_tests[@]}")
}

package() {
  cd jupyterlab-lsp-$pkgname-$pkgver/python_packages/jupyter_lsp
  python -m installer --destdir="$pkgdir" dist/*.whl
  mv "$pkgdir"/usr/etc "$pkgdir"
  install -vDm 644 LICENSE -t "$pkgdir"/usr/share/licenses/$pkgname/

  # remove useless tests directory
  local site_packages=$(python -c "import site; print(site.getsitepackages()[0])")
  rm -frv "$pkgdir/$site_packages"/jupyter_lsp/tests/
}

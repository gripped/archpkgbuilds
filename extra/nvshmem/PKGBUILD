# Maintainer: Jakub Klinkovsk√Ω <lahwaacz at archlinux dot org>

pkgname=nvshmem
pkgver=3.4.5
_cudaver=12
pkgrel=1
pkgdesc="NVIDIA parallel programming interface based on OpenSHMEM"
arch=(x86_64)
url="https://developer.nvidia.com/nvshmem"
license=(LicenseRef-NVIDIA-NVSHMEM)
depends=(
  cuda
  gcc-libs
  glibc
  hwloc
)
optdepends=(
  'libfabric: For OpenFabrics transport plugin'
  'openmpi: For MPI and OpenSHMEM bootstrap plugins'
  'openpmix: For PMI bootstrap plugins'
  'openucx: For UCX transport plugin'
  'rdma-core: For IBGDA transport plugin'
)
options=(!strip staticlibs)
source=(https://developer.download.nvidia.com/compute/nvshmem/redist/libnvshmem/linux-x86_64/lib${pkgname}-linux-x86_64-${pkgver}_cuda${_cudaver}-archive.tar.xz)
b2sums=('0f1cb8da365cd421f4de650317b7e2e6c92182e65ab3bed81e1307a9a3daade196b6ff851406ab63a7f794bde28b2120ae0c5b9c2e36cc040ebc4bcfae7326e1')

package() {
  cd libnvshmem-linux-x86_64-${pkgver}_cuda${_cudaver}-archive

  install -vdm 755 "$pkgdir"/usr/
  cp -arv bin lib "$pkgdir"/usr/
  chmod a-x "$pkgdir"/usr/lib/*.a

  # move bin subdirs into "namespaced" directory
  install -vdm 755 "$pkgdir"/usr/bin/$pkgname/
  mv -v "$pkgdir"/usr/bin/{examples,perftest} "$pkgdir"/usr/bin/$pkgname/

  # install headers into "namespaced" directory
  install -vdm 755 "$pkgdir"/usr/include/
  cp -arv include "$pkgdir"/usr/include/$pkgname

  # fix INCLUDE_DIRS in cmake config file
  sed -i 's|${PACKAGE_PREFIX_DIR}/include|${PACKAGE_PREFIX_DIR}/include/'"$pkgname"'|' "$pkgdir"/usr/lib/cmake/nvshmem/NVSHMEMConfig.cmake

  # install sources
  install -vdm 755 "$pkgdir"/usr/share/$pkgname/
  cp -arv share/src/ "$pkgdir"/usr/share/$pkgname/

  # install license
  install -vDm 644 LICENSE -t "$pkgdir"/usr/share/licenses/$pkgname/
}

# Maintainer: Sven-Hendrik Haase <svenstaro@archlinux.org>
# Maintainer: Caleb Maclennan <caleb@alerque.com>

pkgbase=ethersync
pkgname=teamtype
pkgver=0.9.0
pkgrel=2
pkgdesc='Peer-to-peer, editor-agnostic collaborative editing of local text files'
arch=('x86_64')
url="https://github.com/$pkgname/$pkgname"
license=('AGPL-3.0-only')
makedepends=(rust)
provides=($pkgbase)
replaces=($pkgbase)
conflicts=($pkgbase)
depends=(zlib glibc gcc-libs)
options=('!lto')
source=("$url/archive/refs/tags/v$pkgver/$pkgname-$pkgver.tar.gz")
sha512sums=('9a6eee18b603f3650485125be14c2647b15aeea4ad977dde50493cafce301d044f0991214610eafd77e6973037c4689f39bdbdcb121ec815a71fbe5c63445b7c')

prepare() {
    cd "$pkgname-$pkgver/daemon"
    cargo fetch --locked --target "$(rustc -vV | sed -n 's/host: //p')"
}

build() {
    cd "$pkgname-$pkgver/daemon"
    cargo build --frozen --release
}

check() {
    cd "$pkgname-$pkgver/daemon"
    cargo test --frozen
}

package() {
    cd "$pkgname-$pkgver/daemon/target"
    install -Dm755 -t "$pkgdir/usr/bin/" "release/$pkgname"
    pushd completions
    install -Dm0644 -t "$pkgdir/usr/share/bash-completion/completions/" "$pkgname.bash"
    install -Dm0644 -t "$pkgdir/usr/share/elvish/lib/" "$pkgname.elv"
    install -Dm0644 -t "$pkgdir/usr/share/fish/vendor_completions.d/" "$pkgname.fish"
    # install -Dm0644 -t "$pkgdir/usr/share/nushell/vendor/autoload/" "$pkgname.nu"
    install -Dm0644 -t "$pkgdir/usr/share/zsh/site-functions/" "_$pkgname"
    pushd ../manpages
    install -Dm0644 -t "$pkgdir/usr/share/man/man1/" $pkgname*.1
}

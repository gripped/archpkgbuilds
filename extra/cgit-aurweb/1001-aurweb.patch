From abee1725bb556ce44a1c38f0012c391c5c474bb2 Mon Sep 17 00:00:00 2001
From: Lukas Fleischer <lfleischer@archlinux.org>
Date: Thu, 14 Jan 2016 17:58:07 +0100
Subject: [PATCH 1/2] Add an option to disable the branch switch form

Introduce a configuration option enable-switch-form that is enabled by
default and can be used to disable the branch quick switch form in the
top-right corner of repository pages.

Rationale: For repositories with a huge number of branches, the code
generated for the switch form might become so large that it dominates
the size of the HTTP response. For example, at the time of writing this
commit message, the HTTP body of the Arch Linux community.git cgit index
at https://projects.archlinux.org/svntogit/community.git/ has a size of
228KB. Removing the form shrinks the size to only 12KB.

Signed-off-by: Lukas Fleischer <lfleischer@archlinux.org>
---
 cgit.c       |  6 ++++++
 cgit.h       |  2 ++
 cgitrc.5.txt | 16 ++++++++++++++++
 shared.c     |  1 +
 ui-shared.c  |  2 +-
 5 files changed, 26 insertions(+), 1 deletion(-)

diff --git a/cgit.c b/cgit.c
index 579db64..3cfd91f 100644
--- a/cgit.c
+++ b/cgit.c
@@ -76,6 +76,8 @@ static void repo_config(struct cgit_repo *repo, const char *name, const char *va
 		repo->enable_subject_links = atoi(value);
 	else if (!strcmp(name, "enable-html-serving"))
 		repo->enable_html_serving = atoi(value);
+	else if (!strcmp(name, "enable-switch-form"))
+		repo->enable_switch_form = atoi(value);
 	else if (!strcmp(name, "branch-sort")) {
 		if (!strcmp(value, "age"))
 			repo->branch_sort = 1;
@@ -195,6 +197,8 @@ static void config_cb(const char *name, const char *value)
 		ctx.cfg.enable_subject_links = atoi(value);
 	else if (!strcmp(name, "enable-html-serving"))
 		ctx.cfg.enable_html_serving = atoi(value);
+	else if (!strcmp(name, "enable-switch-form"))
+		ctx.cfg.enable_switch_form = atoi(value);
 	else if (!strcmp(name, "enable-tree-linenumbers"))
 		ctx.cfg.enable_tree_linenumbers = atoi(value);
 	else if (!strcmp(name, "enable-git-config"))
@@ -389,6 +393,7 @@ static void prepare_context(void)
 	ctx.cfg.enable_index_owner = 1;
 	ctx.cfg.enable_tree_linenumbers = 1;
 	ctx.cfg.enable_git_config = 0;
+	ctx.cfg.enable_switch_form = 1;
 	ctx.cfg.max_repo_count = 50;
 	ctx.cfg.max_commit_count = 50;
 	ctx.cfg.max_lock_attempts = 5;
@@ -859,6 +864,7 @@ static void print_repo(FILE *f, struct cgit_repo *repo)
 	fprintf(f, "repo.enable-remote-branches=%d\n", repo->enable_remote_branches);
 	fprintf(f, "repo.enable-subject-links=%d\n", repo->enable_subject_links);
 	fprintf(f, "repo.enable-html-serving=%d\n", repo->enable_html_serving);
+	fprintf(f, "repo.enable-switch-form=%d\n", repo->enable_switch_form);
 	if (repo->branch_sort == 1)
 		fprintf(f, "repo.branch-sort=age\n");
 	if (repo->commit_sort) {
diff --git a/cgit.h b/cgit.h
index 28d2772..b34f589 100644
--- a/cgit.h
+++ b/cgit.h
@@ -106,6 +106,7 @@ struct cgit_repo {
 	int enable_remote_branches;
 	int enable_subject_links;
 	int enable_html_serving;
+	int enable_switch_form;
 	int max_stats;
 	int branch_sort;
 	int commit_sort;
@@ -243,6 +244,7 @@ struct cgit_config {
 	int enable_remote_branches;
 	int enable_subject_links;
 	int enable_html_serving;
+	int enable_switch_form;
 	int enable_tree_linenumbers;
 	int enable_git_config;
 	int local_time;
diff --git a/cgitrc.5.txt b/cgitrc.5.txt
index 6f3e952..92a86ed 100644
--- a/cgitrc.5.txt
+++ b/cgitrc.5.txt
@@ -213,6 +213,18 @@ enable-subject-links::
 	in commit view. Default value: "0". See also:
 	"repo.enable-subject-links".
 
+enable-html-serving::
+	Flag which, when set to "1", will allow the /plain handler to serve
+	mimetype headers that result in the file being treated as HTML by the
+	browser. When set to "0", such file types are returned instead as
+	text/plain or application/octet-stream. Default value: "0". See also:
+	"repo.enable-html-serving".
+
+enable-switch-form::
+	Flag which, when set to "1", will make cgit add a form to the top right
+	of each repository page that allows for quickly switching branches.
+	Default value: "1". See also: "repo.enable-switch-form".
+
 enable-tree-linenumbers::
 	Flag which, when set to "1", will make cgit generate linenumber links
 	for plaintext blobs printed in the tree view. Default value: "1".
@@ -527,6 +539,10 @@ repo.extra-head-content::
 	This value will be added verbatim to the head section of each page
 	displayed for this repo. Default value: none.
 
+repo.enable-switch-form::
+	A flag which can be used to override the global setting
+	`enable-switch-form'. Default value: none.
+
 repo.hide::
 	Flag which, when set to "1", hides the repository from the repository
 	index. The repository can still be accessed by providing a direct path.
diff --git a/shared.c b/shared.c
index 07b38ba..9c3a0e7 100644
--- a/shared.c
+++ b/shared.c
@@ -67,6 +67,7 @@ struct cgit_repo *cgit_add_repo(const char *url)
 	ret->enable_remote_branches = ctx.cfg.enable_remote_branches;
 	ret->enable_subject_links = ctx.cfg.enable_subject_links;
 	ret->enable_html_serving = ctx.cfg.enable_html_serving;
+	ret->enable_switch_form = ctx.cfg.enable_switch_form;
 	ret->max_stats = ctx.cfg.max_stats;
 	ret->branch_sort = ctx.cfg.branch_sort;
 	ret->commit_sort = ctx.cfg.commit_sort;
diff --git a/ui-shared.c b/ui-shared.c
index 838170a..558d3c8 100644
--- a/ui-shared.c
+++ b/ui-shared.c
@@ -1037,7 +1037,7 @@ static void print_header(void)
 		cgit_index_link("index", NULL, NULL, NULL, NULL, 0, 1);
 		html(" : ");
 		cgit_summary_link(ctx.repo->name, NULL, NULL, NULL);
-		if (ctx.env.authenticated) {
+		if (ctx.env.authenticated && ctx.repo->enable_switch_form) {
 			html("</td><td class='form'>");
 			html("<form method='get'>\n");
 			cgit_add_hidden_formfields(0, 1, ctx.qry.page);

From c1f2a30206528978d8faea6323fb0fb18e81c24d Mon Sep 17 00:00:00 2001
From: Lukas Fleischer <lfleischer@archlinux.org>
Date: Thu, 14 Jan 2016 17:57:37 +0100
Subject: [PATCH 2/2] Customize cgit for the AUR

* Mention "AUR" and the package base in the title.
* Replace favicon.ico.
* Link back to the package details page.
* Remove the branch switch form.
* Do not show any commit decorations.
* Do not show branches on the summary page.
* Disable the repository index.
* Drop link to the "refs" page.
* Use proper Git clone URLs.
* Do not guess default branch.
* Only allow branches with the h GET parameter.
* Add branch information to atom entries.
* Extend the syntax highlighting filter.

Signed-off-by: Lukas Fleischer <lfleischer@archlinux.org>
---
 cgit.c                         |   6 +++---
 cmd.c                          |   2 +-
 favicon.ico                    | Bin 1078 -> 575 bytes
 filters/syntax-highlighting.sh |   7 +++++--
 ui-atom.c                      |  11 ++++++++---
 ui-commit.c                    |   1 -
 ui-log.c                       |   1 -
 ui-shared.c                    |  31 +++++++++++++++----------------
 ui-summary.c                   |   2 --
 9 files changed, 32 insertions(+), 29 deletions(-)

diff --git a/cgit.c b/cgit.c
index 3cfd91f..93296d2 100644
--- a/cgit.c
+++ b/cgit.c
@@ -619,7 +619,7 @@ static int prepare_repo_cmd(int nongit)
 	if (!ctx.repo->defbranch)
 		ctx.repo->defbranch = guess_defbranch();
 
-	if (!ctx.qry.head) {
+	if (!ctx.qry.head && !strcmp(ctx.qry.page, "snapshot")) {
 		ctx.qry.nohead = 1;
 		ctx.qry.head = find_default_branch(ctx.repo);
 	}
@@ -629,7 +629,7 @@ static int prepare_repo_cmd(int nongit)
 		cgit_print_docstart();
 		cgit_print_pageheader();
 		cgit_print_error("Repository seems to be empty");
-		if (!strcmp(ctx.qry.page, "summary")) {
+		if (!strcmp(ctx.qry.page, "summary") && ctx.qry.head) {
 			html("<table class='list'><tr class='nohover'><td>&nbsp;</td></tr><tr class='nohover'><th class='left'>Clone</th></tr>\n");
 			cgit_prepare_repo_env(ctx.repo);
 			cgit_add_clone_urls(print_no_repo_clone_urls);
@@ -641,7 +641,7 @@ static int prepare_repo_cmd(int nongit)
 
 	if (repo_get_oid(the_repository, ctx.qry.head, &oid)) {
 		char *old_head = ctx.qry.head;
-		ctx.qry.head = xstrdup(ctx.repo->defbranch);
+		ctx.qry.head = NULL;
 		cgit_print_error_page(404, "Not found",
 				"Invalid branch: %s", old_head);
 		free(old_head);
diff --git a/cmd.c b/cmd.c
index 0eb75b1..cb9c393 100644
--- a/cmd.c
+++ b/cmd.c
@@ -198,7 +198,7 @@ struct cgit_cmd *cgit_get_cmd(void)
 		if (ctx.repo)
 			ctx.qry.page = "summary";
 		else
-			ctx.qry.page = "repolist";
+			return NULL;
 	}
 
 	for (i = 0; i < sizeof(cmds)/sizeof(*cmds); i++)
diff --git a/favicon.ico b/favicon.ico
index 56ff59384f2ce308996d0027bb928c18e2c61785..55497b852fc438a7a63041822a64deac8ad92527 100644
GIT binary patch
literal 575
zcmeAS@N?(olHy`uVBq!ia0y~yU=RRd4mJh`2Kmqb6B!s7Sc;uILpV4%IBGajIv5xj
zI14-?iy0VruY)k7lg8`{1_lPn64!{5;QX|b^2DN4hVt@qz0ADq;^f4FRK5J7^x5xh
zq!<_&_jtNEhFJ9WPPXq5b`&{QZ)|;XSNXGq@DJN8q=hXl`b4@GT-(;v(VLO_kaL+J
z4@bLMRCZza)Yb*P5gk9+Mb>Q)3T(OU>}pswM^nt!g-2!jj?Kvr*@X0k|IDh~^L=ms
zeV!hJV+p|$M}Mnx2bqdJi@#xWYS-WJ=Q4_F4A~7E1mEo1xXYPimaF@!n+N9B*6jII
zImQ3hB=zp1gTY185?4Jpe>R(MdLX!H`*M|elS(eVd2%!T^}l*{nO&bBu6W%MzE0@$
zyh&fSe4M?%s(bOC=z9tG*M2{GAec9KhG*~3iIO$BJs)IlYKf-){I~Jb_l+!#%U=nz
zT0YilG-QdL+j;-ihLxLx+-G|yb3V)4H~W_Gj%?|-SN`96b@B4yl6A^a!Rvw}ZEe5j
zsvKN)?p6MzZTElNe5-HI@b265*jz8^xnB->G#PZ2Gw~)=+f`4wvdaC_&D;ke_wt#a
zE(!Dfr@F&t1J8$o1$DFLv;APY(!Nf>tx(e9@CG~HEBU{VG;rUM=3-dK)Ve2*c^#uX
zJJYNKr3tbt7)~dO%x4g|?5$nhc>RFz1FxXf`%-!iY1nb-Fts;U8t&avBv>);%BpMf
e=4vkv$QNqNe)x9>*B%B21_n=8KbLh*2~7awdi;a{

literal 1078
zcmZQzU}RuoP*4zH0D%`w3=C=v3=9GS5WWT@0|Os31A_(w1A_ts1A_wtNIeTkDMJGj
zn8G0b|NqYr5O9oP_3FnAj0|fSnwzgNT)6mwL0e}hLt5%t1~KtX3~%22V3;xEKEwWf
zFBxoX_c1(t@P)zBWG{oDprD}CiJvYmbHf&b*dT1_0tVMWY(YUm88FYq#S_XGaq-`i
zmUgtnr4b@v;!*`-EO+q&QG$XkE`}h6jEggf5)@Q%fzU3l5E@3hc)(a|tatC;^U%c!
z%3lPw&=<xR19M$mVEiR6E=3(3SK#~>mtP=_Ay9d#5{N@3pnSP05PQX-d@&avka9sm
zINuMA5A_E`R8S1&FPib)ASOe@Lk<>hP`=a@NVv$jctg~wxFmuY>s_GkHgWOTla^-s
z#YGV$EGQ@h4KGhvgtkBgVDTv^XH??iGARtK8Y3~$SpbyIK`9@U))^Tf>HGi=H-OT4
zXy|bU2IeIU)27{JIB?(<gR;sthJu0%47YB7Vz9M4z#t~NiNW3T5JP|OO@{A3{xL8y
ztYL6=Jjfs@82#>*s-U2tsGWNC<3>S2$)|#Xaf*V1GKGSI!V?7r1>1Li@=FvH6g6I!
z_byRTQ0j%CU|pi1;JuB4g2IV{f|m;g1;r0SXi&(3_%QmStf1g!MTk1NhY)kc-$CpV
Q^nCY9Lr@ThmxvYy0QFI@J^%m!

diff --git a/filters/syntax-highlighting.sh b/filters/syntax-highlighting.sh
index 840bc34..8f936e7 100755
--- a/filters/syntax-highlighting.sh
+++ b/filters/syntax-highlighting.sh
@@ -107,6 +107,9 @@ EXTENSION="${BASENAME##*.}"
 # map Makefile and Makefile.* to .mk
 [ "${BASENAME%%.*}" = "Makefile" ] && EXTENSION=mk
 
+[ "${BASENAME}" = "PKGBUILD" ] && EXTENSION=sh
+[ "${EXTENSION}" = "install" ] && EXTENSION=sh
+
 # highlight versions 2 and 3 have different commandline options. Specifically,
 # the -X option that is used for version 2 is replaced by the -O xhtml option
 # for version 3.
@@ -115,7 +118,7 @@ EXTENSION="${BASENAME##*.}"
 # found (for example) on EPEL 6.
 #
 # This is for version 2
-exec highlight --force -f -I -X -S "$EXTENSION" 2>/dev/null
+#exec highlight --force -f -I -X -S "$EXTENSION" 2>/dev/null
 
 # This is for version 3
-#exec highlight --force -f -I -O xhtml -S "$EXTENSION" 2>/dev/null
+exec highlight --force -f -I -O xhtml -S "$EXTENSION" 2>/dev/null
diff --git a/ui-atom.c b/ui-atom.c
index 0659e96..44c6be0 100644
--- a/ui-atom.c
+++ b/ui-atom.c
@@ -15,7 +15,7 @@
 
 static void add_entry(struct commit *commit, const char *host)
 {
-	char delim = '&';
+	char *delim = "&amp;";
 	char *hex;
 	char *mail, *t, *t2;
 	struct commitinfo *info;
@@ -64,8 +64,13 @@ static void add_entry(struct commit *commit, const char *host)
 		pageurl = cgit_pageurl(ctx.repo->url, "commit", NULL);
 		html_attr(pageurl);
 		if (ctx.cfg.virtual_root)
-			delim = '?';
-		html_attrf("%cid=%s", delim, hex);
+			delim = "?";
+		html_attrf("%sid=%s", delim, hex);
+		delim = "&amp;";
+		if (ctx.qry.head) {
+			html(delim);
+			htmlf("h=%s", ctx.qry.head);
+		}
 		html("'/>\n");
 		free(pageurl);
 	}
diff --git a/ui-commit.c b/ui-commit.c
index 972e9bc..7b479c0 100644
--- a/ui-commit.c
+++ b/ui-commit.c
@@ -121,7 +121,6 @@ void cgit_print_commit(char *hex, const char *prefix)
 	cgit_open_filter(ctx.repo->commit_filter);
 	html_txt(info->subject);
 	cgit_close_filter(ctx.repo->commit_filter);
-	show_commit_decorations(commit);
 	html("</div>");
 	html("<div class='commit-msg'>");
 	cgit_open_filter(ctx.repo->commit_filter);
diff --git a/ui-log.c b/ui-log.c
index 31fb783..02fe779 100644
--- a/ui-log.c
+++ b/ui-log.c
@@ -243,7 +243,6 @@ static void print_commit(struct commit *commit, struct rev_info *revs)
 	}
 	cgit_commit_link(info->subject, NULL, NULL, ctx.qry.head,
 			 oid_to_hex(&commit->object.oid), ctx.qry.vpath);
-	show_commit_decorations(commit);
 	html("</td><td>");
 	cgit_open_filter(ctx.repo->email_filter, info->author_email, "log");
 	html_txt(info->author);
diff --git a/ui-shared.c b/ui-shared.c
index 558d3c8..4268e15 100644
--- a/ui-shared.c
+++ b/ui-shared.c
@@ -930,10 +930,10 @@ static void add_clone_urls(void (*fn)(const char *), char *txt, char *suffix)
 
 void cgit_add_clone_urls(void (*fn)(const char *))
 {
-	if (ctx.repo->clone_url)
-		add_clone_urls(fn, expand_macros(ctx.repo->clone_url), NULL);
-	else if (ctx.cfg.clone_prefix)
-		add_clone_urls(fn, ctx.cfg.clone_prefix, ctx.repo->url);
+	struct strbuf url = STRBUF_INIT;
+
+	strbuf_addf(&url, "%s/%s.git/", ctx.cfg.clone_prefix, ctx.qry.head);
+	add_clone_urls(fn, strbuf_detach(&url, NULL), NULL);
 }
 
 static int print_branch_option(const struct reference *ref, void *cb_data)
@@ -1034,9 +1034,12 @@ static void print_header(void)
 
 	html("<td class='main'>");
 	if (ctx.repo) {
-		cgit_index_link("index", NULL, NULL, NULL, NULL, 0, 1);
-		html(" : ");
-		cgit_summary_link(ctx.repo->name, NULL, NULL, NULL);
+		html_txt("AUR");
+		if (ctx.qry.head && strcmp(ctx.qry.head, "")) {
+			html_txt(" : ");
+			html_txt(ctx.qry.head);
+			html_txt(".git");
+		}
 		if (ctx.env.authenticated && ctx.repo->enable_switch_form) {
 			html("</td><td class='form'>");
 			html("<form method='get'>\n");
@@ -1058,13 +1061,11 @@ static void print_header(void)
 	html("<tr><td class='sub'>");
 	if (ctx.repo) {
 		html_txt(ctx.repo->desc);
-		html("</td><td class='sub right'>");
-		if (ctx.repo->owner_filter) {
-			cgit_open_filter(ctx.repo->owner_filter);
-			html_txt(ctx.repo->owner);
-			cgit_close_filter(ctx.repo->owner_filter);
-		} else {
-			html_txt(ctx.repo->owner);
+		if (ctx.qry.head && strcmp(ctx.qry.head, "")) {
+			html(" | click <a href='/pkgbase/");
+			html_txt(ctx.qry.head);
+			html("/'>here</a> to return to the package base details page");
+			html("</td><td class='sub right'>");
 		}
 	} else {
 		if (ctx.cfg.root_desc)
@@ -1087,8 +1088,6 @@ void cgit_print_pageheader(void)
 				    NULL);
 		cgit_summary_link("summary", NULL, hc("summary"),
 				  ctx.qry.head);
-		cgit_refs_link("refs", NULL, hc("refs"), ctx.qry.head,
-			       ctx.qry.oid, NULL);
 		cgit_log_link("log", NULL, hc("log"), ctx.qry.head,
 			      NULL, ctx.qry.vpath, 0, NULL, NULL,
 			      ctx.qry.showmsg, ctx.qry.follow);
diff --git a/ui-summary.c b/ui-summary.c
index 947812a..9c88d01 100644
--- a/ui-summary.c
+++ b/ui-summary.c
@@ -51,8 +51,6 @@ void cgit_print_summary(void)
 
 	cgit_print_layout_start();
 	html("<table summary='repository info' class='list nowrap'>");
-	cgit_print_branches(ctx.cfg.summary_branches);
-	htmlf("<tr class='nohover'><td colspan='%d'>&nbsp;</td></tr>", columns);
 	cgit_print_tags(ctx.cfg.summary_tags);
 	if (ctx.cfg.summary_log > 0) {
 		htmlf("<tr class='nohover'><td colspan='%d'>&nbsp;</td></tr>", columns);

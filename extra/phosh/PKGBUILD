# Maintainer: Dan Johansen <strit@archlinux.org>
# Contributor: Jelle van der Waa <jelle@archlinux.org>
# Contributor: Thomas Booker <tw.booker@outlook.com>
# Contributor: Philip Goto <philip.goto@gmail.com>

pkgname=phosh
pkgver=0.51.0
pkgrel=1
pkgdesc='A Wayland shell for GNOME on mobile devices'
arch=(x86_64)
url='https://gitlab.gnome.org/World/Phosh/phosh'
license=(GPL-3.0-or-later)
depends=(
  appstream
  bash
  cairo
  callaudiod
  dconf
  evince
  evolution-data-server
  feedbackd
  fribidi
  gcc-libs
  gcr
  gdk-pixbuf2
  glib2
  glibc
  gnome-bluetooth-3.0
  gnome-desktop
  gnome-session
  gnome-shell
  gsettings-desktop-schemas
  gtk3
  gtk4
  hicolor-icon-theme
  libadwaita
  libgmobile
  libgudev
  libhandy
  libical
  libmm-glib
  libnm
  libpulse
  libsecret
  libsoup3
  pam
  pango
  phoc
  phosh-osk-provider
  polkit
  systemd-libs
  upower
  wayland
  xdg-desktop-portal-gtk
  xdg-desktop-portal-phosh
  xdg-desktop-portal-wlr
)
makedepends=(
  git
  glib2-devel
  meson
  python-docutils
  wayland-protocols
)
checkdepends=(
  xmlstarlet
  xorg-server-xvfb
)
optdepends=('iio-sensor-proxy: accelerometer and other sensors')
source=(
  "git+https://gitlab.gnome.org/World/Phosh/phosh.git?signed#tag=v$pkgver"
  git+https://gitlab.gnome.org/World/Phosh/libcall-ui.git
  git+https://gitlab.gnome.org/GNOME/libgnome-volume-control.git
  phosh.pam
)
b2sums=(
  76d05f99d3f4051ccf5f3ec9bd44ef12b218f5306bfba682451250186e7c0caf1fde71117866a9e3c5d021949bd14aa36917ca6df6eb6c5ed4768f8929c0a50e
  SKIP
  SKIP
  d89e16605e2e8e29834f9537bd09ef3f76f1cf6420cdd99346a760cab8c7217f86898be66c24b206b464239fc8b5277150abd19bae81af72187a435bd8c2f869
)
validpgpkeys=(0DB3932762F78E592F6522AFBB5A2C77584122D3) # Guido GÃ¼nther <guido@xcpu.ch>

prepare() {
  ln -s "$srcdir/libcall-ui" "$pkgname/subprojects/libcall-ui"
  ln -s "$srcdir/libgnome-volume-control" "$pkgname/subprojects/gvc"
  meson subprojects checkout --sourcedir $pkgname
}

build() {
  arch-meson $pkgname build \
    --libexecdir=/usr/lib/phosh \
    -D phoc_tests=disabled \
    -D man=true
  meson compile -C build
}

check() {
  xvfb-run meson test -C build --print-errorlogs
}

package() {
  meson install -C build --destdir "$pkgdir"
  install -Dm644 "$srcdir"/phosh.pam "$pkgdir"/etc/pam.d/phosh
}

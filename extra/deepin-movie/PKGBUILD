# Maintainer: Felix Yan <felixonmars@archlinux.org>

pkgname=deepin-movie
epoch=1
pkgver=5.10.44
pkgrel=1
pkgdesc='Movie player based on mpv'
arch=('x86_64')
url="https://github.com/linuxdeepin/deepin-movie-reborn"
license=('GPL-3.0-or-later')
depends=('dtkcore' 'dtkgui' 'dtkwidget' 'qt5-base' 'qt5-svg' 'ffmpegthumbnailer' 'libxtst'
         'libglvnd' 'dconf' 'gsettings-qt' 'libva' 'libxcb' 'libx11' 'qt5-x11extras' 'mpv'
         'qt5-multimedia' 'qtdbusextended' 'qtmpris' 'deepin-daemon')
makedepends=('git' 'cmake' 'gtest' 'ninja' 'qt5-tools')
groups=('deepin-extra')
source=("git+https://github.com/linuxdeepin/deepin-movie-reborn.git#tag=$pkgver")
sha512sums=('302ec8f2deff8da9785eafa3be6e8c500a69e413e3984ef109fd34432a563d73ce3fecf2fe8b622cff37a8b73d5df0ae98c6b98f055feb4aaa3731007401d1f8')

prepare() {
  cd deepin-movie-reborn
  # new dtkgui
  git cherry-pick -n adbcf2f754f74947f32546f40d488001d34f3051
  # fix ldflag
  git cherry-pick -n db5d5e36d18ec4b6ce52e83c7a1567d3944cb1d1
  # ffmpeg 7
  git cherry-pick -n 649fc5ebc0b80d8b7b530ae640a2e42280d1cdd6
  sed -i '/include <QDBusReply>/a#include <QTimer>' src/widgets/toolbutton.h
  sed -i 's|QGSettings/QGSettings|qt5/QGSettings/QGSettings|' src/libdmr/compositing_manager.h
}

build() {
  cd deepin-movie-reborn
  export CXXFLAGS+=' -fpermissive'
  cmake -GNinja -DCMAKE_INSTALL_PREFIX=/usr -DCMAKE_INSTALL_LIBDIR=lib -DCMAKE_POLICY_VERSION_MINIMUM=3.5 -DVERSION=$pkgver .
  ninja
}

package() {
  cd deepin-movie-reborn
  DESTDIR="$pkgdir" ninja install
}

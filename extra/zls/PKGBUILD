# Maintainer: Daurnimator <daurnimator@archlinux.org>
# Maintainer: Orhun ParmaksÄ±z <orhun@archlinux.org>
# Contributor: Chocobo1 <chocobo1 AT archlinux DOT net>

pkgname=zls
pkgver=0.15.0
pkgrel=1
pkgdesc="A language server for Zig"
arch=('x86_64')
url="https://github.com/zigtools/zls"
license=('MIT')
depends=('zig')
source=("${pkgname}-${pkgver}.tar.gz::https://github.com/zigtools/zls/archive/refs/tags/${pkgver}.tar.gz")
# From build.zig.zon
source+=(
  "known-folders-92defaee76b07487769ca352fd0ba95bc8b42a2f.tar.gz::https://github.com/ziglibs/known-folders/archive/92defaee76b07487769ca352fd0ba95bc8b42a2f.tar.gz"
  "diffz-a20dd1f11b10819a6f570f98b42e1c91e3704357.tar.gz::https://github.com/ziglibs/diffz/archive/a20dd1f11b10819a6f570f98b42e1c91e3704357.tar.gz"
  "lsp_kit-576e9405b1ab22c17c0f9318feed3278aa66b0ea.tar.gz::https://github.com/zigtools/lsp-kit/archive/576e9405b1ab22c17c0f9318feed3278aa66b0ea.tar.gz"
)
noextract=("${source[@]:1}")
sha256sums=('337d478ca90bab965070ed139408909f1968ad709afb61594b6368dbacc0b631'
            'b2248ce99958d17023fcd60c606fa20c69f089ff6877aa23aecda57824be7844'
            'c4fe9d0624ca5a9499fc4592e404eedb94934491ef214e5199be61c441d7c074'
            'dd20a2951144f9c755c282853542e4f417e60c6673817d044067192444bfdabe')

prepare() {
  zig fetch --global-cache-dir ./zig-global-cache "./${source[1]%%::*}"
  zig fetch --global-cache-dir ./zig-global-cache "./${source[2]%%::*}"
  zig fetch --global-cache-dir ./zig-global-cache "./${source[3]%%::*}"
}

build() {
  cd "${pkgname}-${pkgver}"
  DESTDIR="build" zig build \
    --summary all \
    --global-cache-dir ../zig-global-cache \
    --system ../zig-global-cache/p \
    --prefix /usr \
    --release=safe \
    -Dtarget=native-linux.6.1-gnu.2.38 \
    -Dcpu=baseline \
    -Dpie=true
}

package() {
  cd "${pkgname}-${pkgver}"
  cp -a build/* "$pkgdir"
  install -Dm 644 README.md -t "$pkgdir/usr/share/doc/$pkgname"
  install -Dm 644 LICENSE -t "$pkgdir/usr/share/licenses/$pkgname"
}

# vim: ts=2 sw=2 et:

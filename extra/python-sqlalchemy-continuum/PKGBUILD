# Maintainer: Levente Polyak <anthraxx[at]archlinux[dot]org>
# Maintainer: Jelle van der Waa <jelle@archlinux.org

_name=sqlalchemy-continuum
pkgname=python-sqlalchemy-continuum
pkgver=1.5.0
pkgrel=1
pkgdesc='Versioning and auditing extension for SQLAlchemy'
url='https://github.com/kvesteri/sqlalchemy-continuum'
arch=('any')
license=('BSD')
depends=('python' 'python-sqlalchemy' 'python-sqlalchemy-utils')
makedepends=('python-setuptools' 'python-sphinx' 'python-build' 'python-installer' 'python-wheel')
checkdepends=('sqlite' 'python-pytest' 'python-flexmock' 'python-psycopg2' 'python-mysql-connector'
              'python-flask' 'python-flask-login' 'python-flask-sqlalchemy'
              'python-sqlalchemy-i18n')
optdepends=('python-flask: flask plugin'
            'python-flask-login: flask plugin'
            'python-flask-sqlalchemy: flask plugin'
            'python-sqlalchemy-i18n: internationalization')
options=('!makeflags')
source=(https://files.pythonhosted.org/packages/source/${_name::1}/${_name//-/_}/${_name//-/_}-${pkgver}.tar.gz)
sha512sums=('ce2935d477a280ce70dba9724c3bb0a16ea464d12745931d0466a7ff2a1f9acce9613b5a60818ba235c1f5aa62e6f8e13e9f8b26fceffd5a9219c08138175b52')
b2sums=('b10a84ce1079a59c46a3f15d2a325cb48fb8aef186b98441fb1d3621af7de061f9d317dbffc8298e25b3aebbe62a664ab54bca438e9ff32ed6ee57b3e2ce8b14')

prepare() {
  cd ${_name/-/_}-${pkgver}

  # https://github.com/kvesteri/sqlalchemy-continuum/issues/358
  sed -i '/^intersphinx_mapping =/d' docs/conf.py
}

build() {
  cd ${_name/-/_}-${pkgver}
  python -m build --wheel --no-isolation
  make -C docs text man
}

check() {
  cd ${_name/-/_}-${pkgver}/tests
  DB=sqlite pytest -k 'not test_flask' || true
}

package() {
  cd ${_name/-/_}-${pkgver}
  python -m installer --destdir="$pkgdir" dist/*.whl
  install -Dm 644 LICENSE -t "${pkgdir}/usr/share/licenses/${pkgname}"
  install -Dm 644 README.rst docs/_build/text/* -t "${pkgdir}/usr/share/doc/${pkgname}"
  install -Dm 644 docs/_build/man/sqlalchemy-continuum.1 -t "${pkgdir}/usr/share/man/man1"
  ln -sf /usr/share/man/man1/sqlalchemy-continuum.1.gz "${pkgdir}/usr/share/man/man1/${pkgname}.1.gz"
}

# vim: ts=2 sw=2 et:

# Maintainer: Bruno Pagani <archange@archlinux.org>
# Maintainer: Jakub Klinkovský <lahwaacz at archlinux dot org>
# Maintainer: Konstantin Gizdov <arch at kge dot pw>
# Contributor: Caleb Maclennan <caleb@alerque.com>
# Contributor: Guillaume Horel <guillaume.horel@gmail.com>

_pkg=arrow
_pkgname=pyarrow
pkgname=python-$_pkgname
pkgver=23.0.1
pkgrel=1
# parquet-testing and arrow-testing projects have no releases, commits may need to be updated on pkgver bumps
_parquet_testing_commit=92d45b0752487a4b55fb7f1581c8126ee3e73b0d
_arrow_testing_commit=7b641152dcb0f9e197ebe24a1986151849250959
pkgdesc="Columnar in-memory analytics layer for big data — Python module."
arch=(x86_64)
url="https://arrow.apache.org"
license=(Apache-2.0)
depends=(
  arrow
  glibc
  libgcc
  libstdc++
  python
  python-numpy
)
optdepends=(
  'python-cffi: interact with C code'
  'python-pandas: Pandas integration'
  'python-fsspec: Filesystem Spec support'
)
makedepends=(
  cmake
  cython
  git
  ninja
  python-build
  python-cffi
  python-installer
  python-pandas
  python-setuptools-scm
  python-wheel
)
checkdepends=(
  python-hypothesis
  python-pytest
  python-pytz
)
source=(
  https://archive.apache.org/dist/$_pkg/$_pkg-$pkgver/apache-$_pkg-$pkgver.tar.gz{,.asc}
  git+https://github.com/apache/parquet-testing.git#commit=$_parquet_testing_commit
  git+https://github.com/apache/arrow-testing.git#commit=$_arrow_testing_commit
)
sha512sums=('c687e50dfcdbf7e0e39710224360d35d9aa734452b3a47adc8c101f3019b6b4116310c05b9f3cd0a5ed4ad9b7bd8fb88edb70e79b3cbd413a57e5e35e4554a6c'
            'SKIP'
            'c7995b54e4aaa69c6a2173e057a58d7cf477b78a06787cb50c1ebe38aeba56c8da138fa1370f0187419a3ee3bd1ac7867f3e3379b0a454c7f55e5c1e335b4fb5'
            '9b85bb0ce492894631ec3a234899dd9b5c22181945ee8682ebd5f279cf275ada21d3e3e74e8509b7c045ee34fc417824a0629993d3b373c813a5069916a2a84c')
validpgpkeys=(265F80AB84FE03127E14F01125BCCA5220D84079  # Krisztian Szucs (apache) <szucs.krisztian@gmail.com>
              08D3564B7C6A9CAFBFF6A66791D18FCF079F8007  # Kouhei Sutou <kou@cozmixng.org>
              AF6AADA4C9835B75973FF5DA275C532289DD0F4A  # Raúl Cumplido Domínguez (CODE SIGNING KEY) <raulcd@apache.org>
              A2AC7132B5DA7C273A7A147665F4A8CA9769ECD7) # Apache Arrow Automated Release Signing <private@arrow.apache.org>

build() {
  cd apache-$_pkg-$pkgver/python
  # Documentation for building from source:
  # https://github.com/apache/arrow/blob/main/docs/source/developers/python.rst#relevant-components-and-environment-variables
  # Note that components being disabled or enabled when building PyArrrow is by default based on how Arrow C++ is build.
  PYARROW_BUILD_TYPE="relwithdebinfo" \
  PYARROW_CMAKE_GENERATOR=Ninja \
  PYARROW_CMAKE_OPTIONS="-DARROW_SIMD_LEVEL=NONE -DARROW_RUNTIME_SIMD_LEVEL=MAX" \
  python -m build --wheel --no-isolation
}

check() {
  local pytest_options=(
    -vv
    --pyargs pyarrow
    # ignore test that fails in version 22.0.0
    # test_s3_options etc. crash with aws-sdk-cpp-s3-1.11.710, probably related to https://github.com/apache/arrow/issues/48540
    -k 'not test_timezone_absent and not _s3'
  )

  python -m venv --system-site-packages test-env
  test-env/bin/python -m installer apache-$_pkg-$pkgver/python/dist/*.whl
  PARQUET_TEST_DATA="$srcdir"/parquet-testing/data \
  ARROW_TEST_DATA="$srcdir"/arrow-testing/data \
  test-env/bin/python -m pytest "${pytest_options[@]}"
}

package() {
  cd apache-$_pkg-$pkgver/python
  python -m installer --destdir="$pkgdir" dist/*.whl

  # drop tests from install
  local site_packages=$(python -c "import site; print(site.getsitepackages()[0])")
  rm -rfv "$pkgdir$site_packages"/$_pkgname/{conftest.py,tests}

  # move python include files
  install -vdm 755 "$pkgdir"/usr/include/arrow/
  mv -v "$pkgdir$site_packages"/$_pkgname/include/arrow/python/ "$pkgdir"/usr/include/arrow/
  rm -rfv "$pkgdir$site_packages"/$_pkgname/include/
  ln -sTv /usr/include/arrow/ "$pkgdir$site_packages"/$_pkgname/include
}

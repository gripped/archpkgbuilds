# Maintainer: Caleb Maclennan <caleb@alerque.com>
# Contributor: Jonas Witschel <diabonas@archlinux.org>
# Contributor: Jan de Groot <jgc@archlinux.org>

pkgname=bcprov
_pkgname=bc-java
pkgver=1.80
pkgrel=1
pkgdesc='Bouncy Castle Crypto APIs for Java'
arch=(any)
url='https://www.bouncycastle.org/java.html'
_url='https://github.com/bcgit/bc-java'
license=(MIT)
depends=(java-runtime-headless)
makedepends=(ant
             strip-nondeterminism)
_tag=${pkgver//./v}; _tag=r${_tag/v/rv}
_archive="$_pkgname-$_tag"
source=("$_url/archive/$_tag/$_archive.tar.gz")
sha512sums=('3ae49559a922c650a4024e99db23117db04119a504f1c947175548ab30bebd03d68f9b5f09c4f900851a405ab48a8b3609ae2f7c66aca810354dc0d446620db5')

build() {
	cd "$_archive"
	ant -f ant/jdk18+.xml clean build-provider build
	# Timestamps in JAR files generated by Ant do not honour SOURCE_DATE_EPOCH
	# (https://bz.apache.org/bugzilla/show_bug.cgi?id=61269)
	strip-nondeterminism --timestamp "$SOURCE_DATE_EPOCH" build/artifacts/jdk1.8/jars/bcprov-jdk18on-*.jar
}

# Disabling tests after 1.74. Between 1.74 and 1.75 the test suite itself got
# fixed to actually return an error at the end if tests failed. It turns out it
# has been silently failing all tests for the last several versions anyway, but
# since the suite returned a success at the end we never noticed. The end
# result is a *working* package that does what we need it to for pdftk, so that
# tells me we're just calling the test suite wrong or it wasn't made for this
# use case.
# check() {
# 	cd "$_archive"
# 	ant -f ant/jdk18+.xml test
# }

package() {
	cd "$_archive"
	install -Dm644 -t "$pkgdir/usr/share/java/$pkgname/" build/artifacts/jdk1.8/jars/bcprov-jdk18on-*.jar
	install -Dm644 -t "$pkgdir/usr/share/licenses/$pkgname/" LICENSE.html
	pushd "$pkgdir/usr/share/java/$pkgname/"
	ln -s bcprov-jdk18on-*.jar bcprov.jar
}

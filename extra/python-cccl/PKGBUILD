# Maintainer: Jakub Klinkovsk√Ω <lahwaacz@archlinux.org>

_name=cccl
pkgname=python-$_name
pkgver=0.5.0
pkgrel=1
pkgdesc="CUDA Core Compute Libraries for Python"
arch=(x86_64)
url="https://github.com/NVIDIA/cccl"
license=("Apache-2.0 WITH LLVM-exception")
depends=(
  gcc-libs
  glibc
  python
  python-cuda-bindings
  python-cuda-core
  python-cuda-pathfinder
  python-llvmlite
  python-numba
  python-numba-cuda
  python-numpy
  python-typing_extensions
)
makedepends=(
  cython
  nlohmann-json
  python-build
  python-installer
  python-scikit-build-core
  python-setuptools-scm
  python-wheel
)
source=($pkgname-$pkgver.tar.gz::$url/archive/refs/tags/python-$pkgver.tar.gz)
b2sums=('9326e7f1d49bd3187539a89fc9858b42e6718df49ad108d34500956fa8d912c8bc65fb54bc558486177067375fe671db6ffc0483ba5e4df8ad1745e878a1de19')

prepare() {
  cd $_name-python-$pkgver
  # disable CPM dependency
  sed -i 's|CPMAddPackage("gh:nlohmann/json@3.12.0")|find_package(nlohmann_json REQUIRED)|' cmake/CCCLGetDependencies.cmake
}

build() {
  cd $_name-python-$pkgver/python/cuda_cccl
  SETUPTOOLS_SCM_PRETEND_VERSION=$pkgver \
  python -m build --wheel --no-isolation
}

package() {
  cd $_name-python-$pkgver/python/cuda_cccl
  python -m installer --destdir="$pkgdir" dist/*.whl
  install -vDm 644 ../../LICENSE -t "$pkgdir"/usr/share/licenses/$pkgname/
}

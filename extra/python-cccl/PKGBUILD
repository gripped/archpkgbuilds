# Maintainer: Jakub Klinkovsk√Ω <lahwaacz@archlinux.org>

_name=cccl
pkgname=python-$_name
pkgver=0.5.1
pkgrel=1
pkgdesc="CUDA Core Compute Libraries for Python"
arch=(x86_64)
url="https://github.com/NVIDIA/cccl"
license=("Apache-2.0 WITH LLVM-exception")
depends=(
  gcc-libs
  glibc
  python
  python-cuda-bindings
  python-cuda-core
  python-cuda-pathfinder
  python-llvmlite
  python-numba
  python-numba-cuda
  python-numpy
  python-typing_extensions
)
makedepends=(
  cython
  nlohmann-json
  python-build
  python-installer
  python-scikit-build-core
  python-setuptools-scm
  python-wheel
)
source=($pkgname-$pkgver.tar.gz::$url/archive/refs/tags/python-$pkgver.tar.gz)
b2sums=('16d0d209924ff361f82162c88c4fd1bdad8030d58a8d784f69b92ac460a223ded6d8e564bbbb5adadbb9407399561ade04b17e3b66b08fe1dfb76293c4192035')

prepare() {
  cd $_name-python-$pkgver
  # disable CPM dependency
  sed -i 's|CPMAddPackage("gh:nlohmann/json@3.12.0")|find_package(nlohmann_json REQUIRED)|' cmake/CCCLGetDependencies.cmake
}

build() {
  cd $_name-python-$pkgver/python/cuda_cccl
  SETUPTOOLS_SCM_PRETEND_VERSION=$pkgver \
  python -m build --wheel --no-isolation
}

package() {
  cd $_name-python-$pkgver/python/cuda_cccl
  python -m installer --destdir="$pkgdir" dist/*.whl
  install -vDm 644 ../../LICENSE -t "$pkgdir"/usr/share/licenses/$pkgname/
}

# Maintainer: Felix Yan <felixonmars@archlinux.org>
# Maintainer: Carl Smedstad <carsme@archlinux.org>

pkgname=ponyc
pkgver=0.60.5
pkgrel=1
pkgdesc='An actor model, capabilities, high performance programming language'
arch=('x86_64')
url='https://ponylang.org/'
license=('BSD-2-Clause')
depends=(
  'gcc-libs'
  'glibc'
)
makedepends=(
  'cmake'
  'git'
  'python'
)
options=('!lto')
source=(
  "git+https://github.com/ponylang/ponyc.git#tag=$pkgver"
  "git+https://github.com/llvm/llvm-project.git"
  "ponyc-exclude-failing-test.patch"
  "ponyc-remove-usr-local-refs.patch"
)
b2sums=('181e7dc2345748ec09577532e2765a62f1273cd8a19e3509d244fa78837e188471ff0ef830ad0fcb01d4a070a7ff8f4864a45e2ce3efe65248543debd0705b7f'
        'SKIP'
        '7f1ddbe5d7aac363558b927e29227df94a370baec50818484805f1a95d533554f1505ca1788879a0fc84b2c175e5459a69f1469bc13e1b12082aadd88a5d3c4f'
        'de5e9301abcf937eb754412b730dde359a10d7eaaa1fcab5292f82429d724cdbfa5313aff2eea05c4e479d9d881ae220a80d6ba19b97f9191851f8b48553daaf')

prepare() {
  cd $pkgname
  git submodule init
  git config submodule.lib/llvm/src.url "$srcdir/llvm-project"
  git -c protocol.file.allow=always submodule update \
    lib/llvm/src

  patch -Np1 < ../ponyc-exclude-failing-test.patch
  patch -Np1 < ../ponyc-remove-usr-local-refs.patch
}

build() {
  cd $pkgname
  make prefix=/usr build_flags="$MAKEFLAGS" libs
  make prefix=/usr build_flags="$MAKEFLAGS" arch=x86-64 configure
  make prefix=/usr build_flags="$MAKEFLAGS" build

  mkdir docs
  build/release/ponyc packages/stdlib -rexpr -g -o docs
}

check() {
  cd $pkgname
  make prefix=/usr build_flags="$MAKEFLAGS" test
}

package() {
  cd $pkgname
  make build_flags="$MAKEFLAGS" DESTDIR="$pkgdir/usr/lib/pony" install

  install -vdm755 "$pkgdir/usr/bin"
  ln -vs -t "$pkgdir/usr/bin" /usr/lib/pony/bin/ponyc

  install -vdm755 "$pkgdir/usr/lib"
  ln -vs -t "$pkgdir/usr/lib" /usr/lib/pony/lib/native/libponyc-standalone.a
  ln -vs -t "$pkgdir/usr/lib" /usr/lib/pony/lib/native/libponyc.a
  ln -vs -t "$pkgdir/usr/lib" /usr/lib/pony/lib/native/libponyrt-pic.a
  ln -vs -t "$pkgdir/usr/lib" /usr/lib/pony/lib/native/libponyrt.a

  install -vdm755 "$pkgdir/usr/include/pony/detail"
  ln -vs -t "$pkgdir/usr/include" /usr/lib/pony/include/pony.h
  ln -vs -t "$pkgdir/usr/include/pony/detail" /usr/lib/pony/include/pony/detail/atomics.h

  install -vdm755 "$pkgdir/usr/share/doc/$pkgname"
  cp -va -t "$pkgdir/usr/share/doc/$pkgname" docs/*

  install -vDm644 -t "$pkgdir/usr/share/licenses/$pkgname" LICENSE
}

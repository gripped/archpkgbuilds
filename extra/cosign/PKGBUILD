# Maintainer: Santiago Torres-Arias <santiago@archlinux.org>
# Maintainer: Christian Rebischke <chris.rebischke@archlinux.org>
# Maintainer: Carl Smedstad <carsme@archlinux.org>

pkgname=cosign
pkgver=2.6.0
pkgrel=1
pkgdesc="Container Signing with support for ephemeral keys and Sigstore signing"
arch=('x86_64')
url="https://github.com/sigstore/cosign"
license=('Apache-2.0')
depends=('glibc')
makedepends=(
  'go'
  'git'
)
checkdepends=('go-tools')
options=('!lto')
source=("git+${url}.git#tag=v${pkgver}")
sha512sums=('2e2fbb22047a05888ab209c5c0d0cafe61670604d743c110645aad26b96454b2c170a205fb76506c825ac5e5b4563ba102b3e723b05f46e5fc91f68ca70fde01')
b2sums=('701ed0dc46f358957722f90634e017f48925d51d91f890a4404c2ed1a067ea8b8c363157d81f3e63ac4c456668270f808c4fe3e4374a2862656be2cf28938fe4')

prepare() {
  cd "${pkgname}"
  GOFLAGS="-mod=readonly" go mod vendor -v
}

build(){
  cd "${pkgname}"
  export CGO_LDFLAGS="${LDFLAGS}"
  export CGO_CFLAGS="${CFLAGS}"
  export CGO_CPPFLAGS="${CPPFLAGS}"
  export CGO_CXXFLAGS="${CXXFLAGS}"
  export GOFLAGS="-buildmode=pie -mod=vendor -modcacherw"
  export GOPATH="$srcdir"
  local ld_flags=" \
    -X sigs.k8s.io/release-utils/version.gitVersion=v${pkgver} \
    -compressdwarf=false  \
    -linkmode=external \
  "
  go build -v -ldflags="${ld_flags}" ./cmd/cosign
}

check() {
 cd "${pkgname}"
 go test -v ./...
}

package() {
  cd "${pkgname}"
  install -vDm755 -t "${pkgdir}/usr/bin" cosign
  "$pkgdir"/usr/bin/cosign completion bash \
    | install -vDm644 /dev/stdin "${pkgdir}/usr/share/bash-completion/completions/cosign"
  "$pkgdir"/usr/bin/cosign completion zsh \
    | install -vDm644 /dev/stdin "${pkgdir}/usr/share/zsh/site-functions/_cosign"
  "$pkgdir"/usr/bin/cosign completion fish \
    | install -vDm644 /dev/stdin "${pkgdir}/usr/share/fish/vendor_completions.d/cosign.fish"
}

diff --git a/CMakeLists.txt b/CMakeLists.txt
index c14914a..ffb16aa 100644
--- a/CMakeLists.txt
+++ b/CMakeLists.txt
@@ -5,7 +5,7 @@ project(deepin-camera VERSION 1.0.0)
 add_subdirectory(src)
 
 if (CMAKE_BUILD_TYPE STREQUAL "Debug")
-    add_subdirectory(tests)
+    #add_subdirectory(tests)
 endif()
 
 
diff --git a/libcam/libcam/camview.c b/libcam/libcam/camview.c
index 338ff4d..190d23f 100644
--- a/libcam/libcam/camview.c
+++ b/libcam/libcam/camview.c
@@ -1034,7 +1034,7 @@ void *capture_loop(void *data)
     if(my_options->photo_timer > 0)
     {
         my_photo_timer = NSEC_PER_SEC * my_options->photo_timer;
-        my_last_photo_time = v4l2core_time_get_timestamp(my_vd); /*timer count*/
+        my_last_photo_time = v4l2core_time_get_timestamp(); /*timer count*/
     }
 
     if(my_options->photo_npics > 0)
@@ -1288,9 +1288,9 @@ void *capture_loop(void *data)
  *
  * returns: error code
  */
-int start_encoder_thread(void *data)
+int start_encoder_thread()
 {
-    int ret = __THREAD_CREATE(&encoder_thread, encoder_loop, data);
+    int ret = __THREAD_CREATE(&encoder_thread, encoder_loop, NULL);
 
     if(ret)
         fprintf(stderr, "deepin-camera: encoder thread creation failed (%i)\n", ret);
diff --git a/libcam/libcam_encoder/audio_codecs.c b/libcam/libcam_encoder/audio_codecs.c
index 04e1f61..7fefd6d 100644
--- a/libcam/libcam_encoder/audio_codecs.c
+++ b/libcam/libcam_encoder/audio_codecs.c
@@ -40,7 +40,11 @@ extern int verbosity;
 
 /* AAC object types index: MAIN = 1; LOW = 2; SSR = 3; LTP = 4*/
 static int AAC_OBJ_TYPE[5] =
+#if LIBAVCODEC_VER_AT_LEAST(60,26)
+	{ AV_PROFILE_UNKNOWN, AV_PROFILE_AAC_MAIN, AV_PROFILE_AAC_LOW, AV_PROFILE_AAC_SSR, AV_PROFILE_AAC_LTP };
+#else
 	{ FF_PROFILE_UNKNOWN, FF_PROFILE_AAC_MAIN, FF_PROFILE_AAC_LOW, FF_PROFILE_AAC_SSR, FF_PROFILE_AAC_LTP };
+#endif
 /*-1 = reserved; 0 = freq. is writen explictly (increases header by 24 bits)*/
 static int AAC_SAMP_FREQ[16] =
 	{ 96000, 88200, 64000, 48000, 44100, 32000, 24000, 22050, 16000, 12000, 11025, 8000, 7350, -1, -1, 0};
@@ -66,7 +70,11 @@ static audio_codec_t listSupCodecs[] = //list of software supported formats
 		.codec_id     = AV_CODEC_ID_PCM_F32LE,
 		.codec_name   = "pcm_f32le",
 		.sample_format = AV_SAMPLE_FMT_FLT,
+#if LIBAVCODEC_VER_AT_LEAST(60,26)
+		.profile      = AV_PROFILE_UNKNOWN,
+#else
 		.profile      = FF_PROFILE_UNKNOWN,
+#endif
 		.mkv_codpriv  = NULL,
 		.codpriv_size = 0,
 		.flags        = 0,
@@ -83,7 +91,11 @@ static audio_codec_t listSupCodecs[] = //list of software supported formats
 		.codec_id     = AV_CODEC_ID_MP2,
 		.codec_name   = "mp2",
 		.sample_format = AV_SAMPLE_FMT_S16,
+#if LIBAVCODEC_VER_AT_LEAST(60,26)
+		.profile      = AV_PROFILE_UNKNOWN,
+#else
 		.profile      = FF_PROFILE_UNKNOWN,
+#endif
 		.mkv_codpriv  = NULL,
 		.codpriv_size = 0,
 		.flags        = 0,
@@ -104,7 +116,11 @@ static audio_codec_t listSupCodecs[] = //list of software supported formats
 #else
 		.sample_format = AV_SAMPLE_FMT_S16,
 #endif
+#if LIBAVCODEC_VER_AT_LEAST(60,26)
+		.profile      = AV_PROFILE_UNKNOWN,
+#else
 		.profile      = FF_PROFILE_UNKNOWN,
+#endif
 		.mkv_codpriv  = NULL,
 		.codpriv_size = 0,
 		.flags        = 0,
@@ -125,7 +141,11 @@ static audio_codec_t listSupCodecs[] = //list of software supported formats
 #else
 		.sample_format = AV_SAMPLE_FMT_FLT,
 #endif
+#if LIBAVCODEC_VER_AT_LEAST(60,26)
+		.profile      = AV_PROFILE_UNKNOWN,
+#else
 		.profile      = FF_PROFILE_UNKNOWN,
+#endif
 		.mkv_codpriv  = NULL,
 		.codpriv_size = 0,
 		.flags        = 0,
@@ -146,7 +166,11 @@ static audio_codec_t listSupCodecs[] = //list of software supported formats
 #else
 		.sample_format = AV_SAMPLE_FMT_S16,
 #endif
+#if LIBAVCODEC_VER_AT_LEAST(60,26)
+		.profile      = AV_PROFILE_AAC_LOW,
+#else
 		.profile      = FF_PROFILE_AAC_LOW,
+#endif
 		.mkv_codpriv  = AAC_ESDS,
 		.codpriv_size = 2,
 		.flags        = 0,
@@ -167,7 +191,11 @@ static audio_codec_t listSupCodecs[] = //list of software supported formats
 #else
 		.sample_format = AV_SAMPLE_FMT_S16,
 #endif
+#if LIBAVCODEC_VER_AT_LEAST(60,26)
+		.profile      = AV_PROFILE_UNKNOWN,
+#else
 		.profile      = FF_PROFILE_UNKNOWN,
+#endif
 		.mkv_codpriv  =  NULL,
 		.codpriv_size =  0,
 		.flags        = 0,
@@ -418,7 +446,7 @@ int encoder_set_valid_audio_codec_list ()
 	int num_codecs = 0;
 	for ( ind = 0; ind < encoder_get_audio_codec_list_size(); ++ind)
 	{
-        AVCodec *codec = getLoadLibsInstance()->m_avcodec_find_encoder(listSupCodecs[ind].codec_id);
+        const AVCodec *codec = getLoadLibsInstance()->m_avcodec_find_encoder(listSupCodecs[ind].codec_id);
 		if (!codec)
 		{
 			printf("ENCODER: no audio codec detected for %s\n", listSupCodecs[ind].description);
diff --git a/libcam/libcam_encoder/encoder.c b/libcam/libcam_encoder/encoder.c
index 27194d9..b8479fe 100644
--- a/libcam/libcam_encoder/encoder.c
+++ b/libcam/libcam_encoder/encoder.c
@@ -305,7 +305,7 @@ void /*__attribute__ ((destructor))*/ gviewencoder_fini()
  *
  * returns: 1 - sample format is supported; 0 - is not supported
  */
-static int encoder_check_audio_sample_fmt(AVCodec *codec, enum AVSampleFormat sample_fmt)
+static int encoder_check_audio_sample_fmt(const AVCodec *codec, enum AVSampleFormat sample_fmt)
 {
     const enum AVSampleFormat *p = codec->sample_fmts;
 
@@ -511,10 +511,11 @@ static encoder_video_context_t *encoder_video_init(encoder_context_t *encoder_ct
     }
 
     video_codec_data->codec_context = getLoadLibsInstance()->m_avcodec_alloc_context3(video_codec_data->codec);
-
+#if !LIBAVCODEC_VER_AT_LEAST(57, 107)
     getLoadLibsInstance()->m_avcodec_get_context_defaults3(
         video_codec_data->codec_context,
         video_codec_data->codec);
+#endif
 
     if (video_codec_data->codec_context == NULL) {
         fprintf(stderr, "ENCODER: FATAL memory allocation failure (encoder_video_init): %s\n", strerror(errno));
@@ -761,7 +762,9 @@ static encoder_audio_context_t *encoder_audio_init(encoder_context_t *encoder_ct
     }
 
     audio_codec_data->codec_context = getLoadLibsInstance()->m_avcodec_alloc_context3(audio_codec_data->codec);
+#if !LIBAVCODEC_VER_AT_LEAST(57, 107)
     getLoadLibsInstance()->m_avcodec_get_context_defaults3(audio_codec_data->codec_context, audio_codec_data->codec);
+#endif
 
     if (audio_codec_data->codec_context == NULL) {
         fprintf(stderr, "ENCODER: FATAL memory allocation failure (encoder_audio_init): %s\n", strerror(errno));
@@ -777,12 +780,19 @@ static encoder_audio_context_t *encoder_audio_init(encoder_context_t *encoder_ct
     audio_codec_data->codec_context->flags |= audio_defaults->flags;
 
     audio_codec_data->codec_context->sample_rate = encoder_ctx->audio_samprate;
+#if LIBAVCODEC_VER_AT_LEAST(58, 0)
+	if (encoder_ctx->audio_channels < 2)
+		getAvutil()->m_av_channel_layout_copy(&(audio_codec_data->codec_context->ch_layout), &(AVChannelLayout)AV_CHANNEL_LAYOUT_MONO);
+	else
+		getAvutil()->m_av_channel_layout_copy(&(audio_codec_data->codec_context->ch_layout), &(AVChannelLayout)AV_CHANNEL_LAYOUT_STEREO);
+#else
     audio_codec_data->codec_context->channels = encoder_ctx->audio_channels;
 
     if (encoder_ctx->audio_channels < 2)
         audio_codec_data->codec_context->channel_layout = AV_CH_LAYOUT_MONO;
     else
         audio_codec_data->codec_context->channel_layout = AV_CH_LAYOUT_STEREO;
+#endif
 
     audio_codec_data->codec_context->cutoff = 0; /*automatic*/
 
@@ -916,8 +926,12 @@ static encoder_audio_context_t *encoder_audio_init(encoder_context_t *encoder_ct
 
     audio_codec_data->frame->nb_samples = frame_size;
     audio_codec_data->frame->format = audio_defaults->sample_format;
+#if LIBAVCODEC_VER_AT_LEAST(58, 0)
+    getAvutil()->m_av_channel_layout_copy(&audio_codec_data->frame->ch_layout, &audio_codec_data->codec_context->ch_layout);
+#else
     audio_codec_data->frame->channels = audio_codec_data->codec_context->channels;
     audio_codec_data->frame->channel_layout = audio_codec_data->codec_context->channel_layout;
+#endif
 
     /*set codec data in encoder context*/
     enc_audio_ctx->codec_data = (void *) audio_codec_data;
@@ -1521,10 +1535,17 @@ static int libav_send_encode(AVCodecContext *avctx, AVFrame *frame)
 
         if (avctx->codec_type == AVMEDIA_TYPE_AUDIO && frame->nb_samples != avctx->frame_size)
             fprintf(stderr, "ENCODER: audio samples differ from frame size\n");
+#if LIBAVCODEC_VER_AT_LEAST(58, 0)
+		if (frame->ch_layout.nb_channels <= 0) {
+			fprintf(stderr, "ENCODER: no audio channels set in frame\n");
+			getAvutil()->m_av_channel_layout_copy(&frame->ch_layout, &avctx->ch_layout);
+		}
+#else
         if (avctx->codec_type == AVMEDIA_TYPE_AUDIO && frame->channels <= 0) {
             fprintf(stderr, "ENCODER: no audio channels set in frame\n");
             frame->channels = avctx->channels;
         }
+#endif
         ret = getLoadLibsInstance()->m_avcodec_send_frame(avctx, frame);
         if (ret < 0) {
             //  fprintf(stderr, "ENCODER: avcodec_send_frame error (%i): %s\n", ret, av_err2str(ret));
@@ -1788,7 +1809,11 @@ int encoder_encode_audio(encoder_context_t *encoder_ctx, void *audio_data)
 
         int buffer_size = getAvutil()->m_av_samples_get_buffer_size(
                               NULL,
+#if LIBAVCODEC_VER_AT_LEAST(58, 0)
+                              audio_codec_data->codec_context->ch_layout.nb_channels,
+#else
                               audio_codec_data->codec_context->channels,
+#endif
                               audio_codec_data->codec_context->frame_size,
                               audio_codec_data->codec_context->sample_fmt,
                               align);
@@ -1796,7 +1821,11 @@ int encoder_encode_audio(encoder_context_t *encoder_ctx, void *audio_data)
         if (buffer_size <= 0) {
             fprintf(stderr, "ENCODER: (encoder_encode_audio) PCM av_samples_get_buffer_size error (%d): chan(%d) nb_samp(%d) samp_fmt(%d)\n",
                     buffer_size,
+#if LIBAVCODEC_VER_AT_LEAST(58, 0)
+                    audio_codec_data->codec_context->ch_layout.nb_channels,
+#else
                     audio_codec_data->codec_context->channels,
+#endif
                     audio_codec_data->codec_context->frame_size,
                     audio_codec_data->codec_context->sample_fmt);
 
@@ -1829,7 +1858,11 @@ int encoder_encode_audio(encoder_context_t *encoder_ctx, void *audio_data)
 
         int buffer_size = getAvutil()->m_av_samples_get_buffer_size(
                               NULL,
+#if LIBAVCODEC_VER_AT_LEAST(58, 0)
+                              audio_codec_data->codec_context->ch_layout.nb_channels,
+#else
                               audio_codec_data->codec_context->channels,
+#endif
                               audio_codec_data->frame->nb_samples,
                               audio_codec_data->codec_context->sample_fmt,
                               align);
@@ -1837,7 +1870,11 @@ int encoder_encode_audio(encoder_context_t *encoder_ctx, void *audio_data)
         if (buffer_size <= 0) {
             fprintf(stderr, "ENCODER: (encoder_encode_audio) av_samples_get_buffer_size error (%d): chan(%d) nb_samp(%d) samp_fmt(%d)\n",
                     buffer_size,
+#if LIBAVCODEC_VER_AT_LEAST(58, 0)
+                    audio_codec_data->codec_context->ch_layout.nb_channels,
+#else
                     audio_codec_data->codec_context->channels,
+#endif
                     audio_codec_data->frame->nb_samples,
                     audio_codec_data->codec_context->sample_fmt);
 
@@ -1848,7 +1885,11 @@ int encoder_encode_audio(encoder_context_t *encoder_ctx, void *audio_data)
         /*set the data pointers in frame*/
         ret = getLoadLibsInstance()->m_avcodec_fill_audio_frame(
                   audio_codec_data->frame,
+#if LIBAVCODEC_VER_AT_LEAST(58, 0)
+                  audio_codec_data->codec_context->ch_layout.nb_channels,
+#else
                   audio_codec_data->codec_context->channels,
+#endif
                   audio_codec_data->codec_context->sample_fmt,
                   (const uint8_t *) audio_data,
                   buffer_size,
@@ -1857,7 +1898,11 @@ int encoder_encode_audio(encoder_context_t *encoder_ctx, void *audio_data)
         if (ret < 0) {
             fprintf(stderr, "ENCODER: (encoder_encode_audio) avcodec_fill_audio_frame error (%d): chan(%d) nb_samp(%d) samp_fmt(%d) buff(%d bytes)\n",
                     ret,
+#if LIBAVCODEC_VER_AT_LEAST(58, 0)
+                    audio_codec_data->codec_context->ch_layout.nb_channels,
+#else
                     audio_codec_data->codec_context->channels,
+#endif
                     audio_codec_data->frame->nb_samples,
                     audio_codec_data->codec_context->sample_fmt,
                     buffer_size);
diff --git a/libcam/libcam_encoder/encoder.h b/libcam/libcam_encoder/encoder.h
index e352ec0..61f0463 100644
--- a/libcam/libcam_encoder/encoder.h
+++ b/libcam/libcam_encoder/encoder.h
@@ -155,7 +155,7 @@ int64_t get_video_pause_timestamp(void);
  * need to export any of it's symbols in the public API
  */
 typedef struct _encoder_codec_data_t {
-    AVCodec *codec;
+    const AVCodec *codec;
     AVDictionary *private_options;
     AVCodecContext *codec_context;
     AVFrame *frame;
diff --git a/libcam/libcam_encoder/mp4.c b/libcam/libcam_encoder/mp4.c
index f4ad069..45e98c8 100644
--- a/libcam/libcam_encoder/mp4.c
+++ b/libcam/libcam_encoder/mp4.c
@@ -21,6 +21,7 @@
 
 #include "mp4.h"
 #include <libavutil/mathematics.h>
+#include "camview.h"
 #include "load_libs.h"
 
 static int64_t video_pts = 0;
diff --git a/libcam/libcam_encoder/video_codecs.c b/libcam/libcam_encoder/video_codecs.c
index 59112a7..3c200cd 100644
--- a/libcam/libcam_encoder/video_codecs.c
+++ b/libcam/libcam_encoder/video_codecs.c
@@ -974,7 +974,7 @@ int encoder_set_valid_video_codec_list ()
 	int num_codecs = 1; /*raw codec (no encoding) is always valid*/
 	for ( ind = 1; ind < encoder_get_video_codec_list_size(); ++ind)
 	{
-        AVCodec *codec = getLoadLibsInstance()->m_avcodec_find_encoder(listSupCodecs[ind].codec_id);
+        const AVCodec *codec = getLoadLibsInstance()->m_avcodec_find_encoder(listSupCodecs[ind].codec_id);
 		if (!codec)
 		{
 			printf("ENCODER: no video codec detected for %s\n", listSupCodecs[ind].description);
diff --git a/libcam/libcam_v4l2core/jpeg_decoder.c b/libcam/libcam_v4l2core/jpeg_decoder.c
index 6d59bdc..20892ba 100644
--- a/libcam/libcam_v4l2core/jpeg_decoder.c
+++ b/libcam/libcam_v4l2core/jpeg_decoder.c
@@ -1356,7 +1356,7 @@ void jpeg_close_decoder()
 
 typedef struct _codec_data_t
 {
-	AVCodec *codec;
+	const AVCodec *codec;
 	AVCodecContext *context;
 	AVFrame *picture;
 } codec_data_t;
@@ -1413,7 +1413,9 @@ int jpeg_init_decoder(int width, int height)
 		return E_NO_CODEC;
 	}
 
-#if LIBAVCODEC_VER_AT_LEAST(53,6)
+#if LIBAVCODEC_VER_AT_LEAST(57, 107)
+    codec_data->context = getLoadLibsInstance()->m_avcodec_alloc_context3(codec_data->codec);
+#elif LIBAVCODEC_VER_AT_LEAST(53,6)
     codec_data->context = getLoadLibsInstance()->m_avcodec_alloc_context3(codec_data->codec);
     getLoadLibsInstance()->m_avcodec_get_context_defaults3 (codec_data->context, codec_data->codec);
 #else
diff --git a/libcam/libcam_v4l2core/uvc_h264.c b/libcam/libcam_v4l2core/uvc_h264.c
index bfad684..6224bf2 100644
--- a/libcam/libcam_v4l2core/uvc_h264.c
+++ b/libcam/libcam_v4l2core/uvc_h264.c
@@ -49,7 +49,7 @@ extern int verbosity;
 
 typedef struct _h264_decoder_context_t
 {
-	AVCodec *codec;
+	const AVCodec *codec;
 	AVCodecContext *context;
 	AVFrame *picture;
 
@@ -1004,7 +1004,9 @@ int h264_init_decoder(int width, int height)
 		return E_NO_CODEC;
 	}
 
-#if LIBAVCODEC_VER_AT_LEAST(53,6)
+#if LIBAVCODEC_VER_AT_LEAST(57, 107)
+    h264_ctx->context = getLoadLibsInstance()->m_avcodec_alloc_context3(h264_ctx->codec);
+#elif LIBAVCODEC_VER_AT_LEAST(53,6)
     h264_ctx->context = getLoadLibsInstance()->m_avcodec_alloc_context3(h264_ctx->codec);
     getLoadLibsInstance()->m_avcodec_get_context_defaults3 (h264_ctx->context, h264_ctx->codec);
 #else
diff --git a/libcam/libcam_v4l2core/v4l2_core.c b/libcam/libcam_v4l2core/v4l2_core.c
index 2824ddf..c4a74fd 100644
--- a/libcam/libcam_v4l2core/v4l2_core.c
+++ b/libcam/libcam_v4l2core/v4l2_core.c
@@ -2664,7 +2664,7 @@ int v4l2core_probe_h264_config_probe_req(
 /*
  * check for new devices
  * args:
- *   vd - pointer to v4l2 device handler
+ *   none
  *
  * asserts:
  *   my_device_list.udev is not null
@@ -2673,9 +2673,9 @@ int v4l2core_probe_h264_config_probe_req(
  *
  * returns: true(1) if device list was updated, false(0) otherwise
  */
-int v4l2core_check_device_list_events(v4l2_dev_t *vd)
+int v4l2core_check_device_list_events()
 {
-	return check_device_list_events(vd);
+	return check_device_list_events(NULL);
 }
 
 /* get frame format index from format list
diff --git a/src/src/LPF_V4L2.c b/src/src/LPF_V4L2.c
index a91fd41..861e0f3 100644
--- a/src/src/LPF_V4L2.c
+++ b/src/src/LPF_V4L2.c
@@ -107,7 +107,7 @@ int camInit(const char *devicename)
     }
 
     if (my_options->disable_libv4l2)
-        v4l2core_disable_libv4l2(my_vd);
+        v4l2core_disable_libv4l2();
 
     /*选择捕捉方式*/
     if (strcasecmp(my_config->capture, "read") == 0)
diff --git a/src/src/basepub/load_libs.c b/src/src/basepub/load_libs.c
index 34559c9..b2d2650 100644
--- a/src/src/basepub/load_libs.c
+++ b/src/src/basepub/load_libs.c
@@ -363,6 +363,10 @@ static LoadAvutil *newAvutil(void)
     PrintError();
     Avutil->m_av_image_alloc = (uos_av_image_alloc)dlsym(handle5, "av_image_alloc");  
     PrintError();
+#if LIBAVCODEC_VER_AT_LEAST(58, 0)
+    Avutil->m_av_channel_layout_copy = (uos_av_channel_layout_copy)dlsym(handle5, "av_channel_layout_copy");  
+    PrintError();
+#endif
     
     assert(Avutil != NULL);
     return Avutil;
diff --git a/src/src/basepub/load_libs.h b/src/src/basepub/load_libs.h
index e890a84..c9e395e 100644
--- a/src/src/basepub/load_libs.h
+++ b/src/src/basepub/load_libs.h
@@ -88,6 +88,7 @@ typedef int (*uos_av_hwframe_transfer_data)( AVFrame *dst, const AVFrame *src, i
 typedef int (*uos_av_buffer_unref)( AVBufferRef **buf);
 typedef AVBufferRef *(*uos_av_buffer_ref)( AVBufferRef *buf);      //AVBufferRef *av_buffer_ref(AVBufferRef *buf);
 typedef int (*uos_av_image_alloc)( uint8_t *pointers[4], int linesizes[4],int w, int h, enum AVPixelFormat pix_fmt, int align); 
+typedef int (*uos_av_channel_layout_copy) (AVChannelLayout *dst, const AVChannelLayout *src);
 typedef struct SwsContext  *(*uos_sws_getContext)( int srcW, int srcH, enum AVPixelFormat srcFormat,\
                                   int dstW, int dstH, enum AVPixelFormat dstFormat,\
                                   int flags, SwsFilter *srcFilter,\
@@ -265,6 +266,7 @@ typedef struct _LoadAvutil {
     uos_av_buffer_unref  m_av_buffer_unref;
     uos_av_buffer_ref  m_av_buffer_ref;
     uos_av_image_alloc  m_av_image_alloc;
+    uos_av_channel_layout_copy  m_av_channel_layout_copy;
 
 } LoadAvutil;
 LoadAvutil *getAvutil();

# Maintainer: David Runge <dvzrv@archlinux.org>

pkgname=deltachat-desktop
pkgver=1.52.0
pkgrel=1
pkgdesc="Email-based instant messaging for Desktop"
arch=(any)
url="https://github.com/deltachat/deltachat-desktop"
license=(GPL-3.0-or-later)
_electronver=32
_nodever=20
depends=(
  "electron$_electronver"
  bash
  deltachat-rpc-server
  hicolor-icon-theme
)
makedepends=(
  "nodejs>=$_nodever"
  git
  inkscape
  node-gyp
  pnpm
)
source=(
  "git+$url.git#tag=v$pkgver"
  "$pkgname.desktop"
  "$pkgname.sh.in"
  "$pkgname.xml"
)
sha512sums=('81a0a01a99665003f7b0c411f06413358ead85dba0733ceefd17912365b361e98285bd7e375344e23ed3147f41a3e76f9046f22b558366d6b04a7d30bb1e6076'
            '15c500b06f28625c65f09f2cbc8fa8c1ce4b7bb5a8e2b6a74136247a29cda5f1f58232b213bfe94700d17190fe4e994b893bd7ebda387942d409b4d000b0577d'
            'b535f19762d6f8d3b23a6bfdac191e65b48df2f51e85312ccf62aea4c65252ab9a546296abd70cef6c53fcf9757bbdc1ee9ce73a6c4d6593854b6d3d0e6de5b3'
            'd725ac91703cdfc4cb14e73cd786456eb4bfc374a591e9508edc70e59350915c365a367b84c1fafce225da01cfb716c516aa7159ecb484635d58467359fb89d7')
b2sums=('0d7e3952c200a1a1a8f7aab1ed1c0ff99bea8265d1b460f504048345ab21400997c7360b6360cab262da57a5087707031a82a6890dd4f7eb3ee04cfbea77e6c1'
        '9826771b90c460169f1fa5c15cc603e28887d669c0ee3ceed9bf1b027a0df7de4bcdbedf4775e8bd8d5b7692ed084a5837a7bcc6c64bf6acf08e8a44586ccf77'
        'f1f34820c56196d0b0c630ddad51c2b650a45a2d5dd3025f479a1f72c9d817b7446fd6793a13b72b90f2b81a4f27f9dd5fc61d110725b5502cb1ec298693a113'
        '382dd6312e10d1881c39d74179f19d41beccb25a5e25a43aa9721fba30e3138ce521df483beed1b6101e1801233b0d189846b7614652d05c5d41feae03f1c5fe')

_resolutions=( 16 32 48 64 96 128 256 512 1024 )

prepare() {
  # set electron version for start script
  sed "s/@ELECTRON@/electron$_electronver/" $pkgname.sh.in > $pkgname.sh

  cd $pkgname

  # generate icons for XDG integration
  for resolution in "${_resolutions[@]}"; do
    inkscape -o "$pkgname-$resolution.png" -w "$resolution" -h "$resolution" images/tray/${pkgname/-desktop/}.svg
  done

  grep -q "\"version\": \"$pkgver\"" packages/target-electron/package.json \
    || ( echo "Version mismatch in package.json"; exit 1 )
  grep -q "\"electron\": \"^$_electronver\." packages/target-electron/package.json \
    || ( echo "Electron version mismatch in package.json"; exit 1 )
  grep -q "\"node\": \">=$_nodever" packages/target-electron/package.json \
    || ( echo "Node version mismatch in package.json"; exit 1 )

  # Update pnpm version requirement
  sed -i "s/\"pnpm\": \".*\"/\"pnpm\": \"^$(pnpm --version)\"/" package.json

  pnpm install --frozen-lockfile
}

build() {
  local electron_builder_options=(
    --linux
    --dir
    -c.electronDist=/usr/lib/electron$_electronver
    -c.electronVersion=$_electronver
  )
  local filter="@deltachat-desktop/target-electron"

  cd $pkgname
  export NODE_ENV=production
  pnpm --filter=$filter pack:generate_config
  pnpm --filter=$filter run pack:patch-node-modules
  pnpm --filter=$filter build
  pnpm --filter=$filter exec electron-builder ${electron_builder_options[@]}

  # symlink bundled stdio-rpc-server to the one provided by the deltachat-rpc-server package
  ln -fsv /usr/bin/deltachat-rpc-server packages/target-electron/dist/linux-unpacked/resources/app.asar.unpacked/node_modules/@deltachat/stdio-rpc-server-linux-x64/deltachat-rpc-server
}

package() {
  install -vDm 755 $pkgname.sh "$pkgdir/usr/bin/$pkgname"

  cd $pkgname
  install -vdm 755 "$pkgdir/usr/lib/$pkgname/"
  cp -rv packages/target-electron/dist/linux-unpacked/resources/* "$pkgdir/usr/lib/$pkgname/"

  # icons
  install -vDm 644 images/tray/${pkgname/-desktop/}.svg "$pkgdir/usr/share/icons/hicolor/scalable/apps/$pkgname.svg"
  for resolution in "${_resolutions[@]}"; do
    install -vDm 644 "$pkgname-$resolution.png" "$pkgdir/usr/share/icons/hicolor/${resolution}x${resolution}/apps/$pkgname.png"
  done

  #XDG
  install -vDm 644 ../$pkgname.desktop -t "$pkgdir/usr/share/applications/"
  install -vDm 644 ../$pkgname.xml -t "$pkgdir/usr/share/mime/packages/"

  install -vDm 644 {CHANGELOG,CONTRIBUTING,README,SECURITY}.md -t "$pkgdir/usr/share/doc/$pkgname/"
}

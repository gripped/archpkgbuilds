# Maintainer: Bruno Pagani <archange@archlinux.org>
# Maintainer: Jakub Klinkovský <lahwaacz at archlinux dot org>
# Contributor: Mathieu Westphal <mathieu.westphal@kitware.com>
# Contributor: Stéphane Gaudreault <stephane@archlinux.org>
# Contributor: <xantares09@hotmail.com>

pkgname=paraview
pkgver=6.0.1
pkgrel=9
pkgdesc="Parallel Visualization application using VTK"
arch=(x86_64)
url="https://www.paraview.org"
license=(BSD-3-Clause)
depends=(
  cgns
  double-conversion
  fmt libfmt.so
  gcc-libs
  gdal
  gl2ps
  glibc
  hdf5
  jsoncpp libjsoncpp.so
  libglvnd libGLX.so libOpenGL.so
  liblas
  libx11
  libxcursor
  libxslt # xsltproc executable
  lz4 liblz4.so
  netcdf
  onetbb
  openmpi libmpi.so
  paraview-catalyst
  pdal
  proj
  protobuf libprotobuf.so
  pugixml
  python
  python-mpi4py
  python-numpy
  qt6-5compat
  qt6-base
  qt6-svg # for showing icons in the UI
  qt6-tools
  vtk
  zlib libz.so
  # vtk optdepends
  adios2
  ffmpeg
  freetype2
  libogg
  libtheora
  ospray
  viskores
)
optdepends=(
  python-matplotlib
  python-pandas
)
makedepends=(
  boost
  cli11
  cmake
  eigen
  fast_float
  gcc-fortran
  mesa
  ninja
  nlohmann-json
  qt6-svg
  utf8cpp
)
source=(
  $url/files/v${pkgver%.*}/ParaView-v${pkgver/R/-R}.tar.xz
  qt-6.10.1.patch
)
b2sums=('e19a8b56f619fb47630152439af3ac7f3be1138b938db443f579e87a9c403bdd8b38798fa591c3607232252ebca49b62762935bb03f0ac416399d9502a24820d'
        '17b4e616a5fec682ddf7c45e02195a913b231f2bd24debb0b1a32f0ca09b73c2bb9eecfadc548016f8bc88319f8f8324afda259501e5e04243f197de346e8656')

prepare() {
  cd ParaView-v${pkgver/R/-R}
  patch -p1 -i ../qt-6.10.1.patch # Fix build with Qt 6.10.1
}

build() {
  export CFLAGS+=" -ffat-lto-objects"
  export CXXFLAGS+=" -ffat-lto-objects"
  local cmake_options=(
    -B build
    -S ParaView-v${pkgver/R/-R}
    -G Ninja
    -W no-dev
    -DCMAKE_BUILD_TYPE=Release
    -DCMAKE_INSTALL_PREFIX=/usr
    -DCMAKE_INSTALL_LICENSEDIR=share/licenses/paraview
    -DCMAKE_CXX_STANDARD=17
    # RPATH is needed for loading plugins
    -DCMAKE_SKIP_INSTALL_RPATH=OFF
    -DPARAVIEW_ENABLE_ADIOS2=ON
    -DPARAVIEW_ENABLE_CATALYST=ON
    -DPARAVIEW_ENABLE_FFMPEG=ON
    -DPARAVIEW_ENABLE_FIDES=ON
    -DPARAVIEW_ENABLE_GDAL=ON
    -DPARAVIEW_ENABLE_LAS=ON
    -DPARAVIEW_ENABLE_MOTIONFX=ON
    -DPARAVIEW_ENABLE_PDAL=ON
    -DPARAVIEW_ENABLE_RAYTRACING=ON
    -DPARAVIEW_ENABLE_VISITBRIDGE=ON
    -DPARAVIEW_ENABLE_XDMF3=ON
    -DPARAVIEW_USE_MPI=ON
    -DPARAVIEW_USE_PYTHON=ON
    -DPARAVIEW_VERSIONED_INSTALL=OFF
    -DPARAVIEW_BUILD_WITH_EXTERNAL=ON
    -DPARAVIEW_USE_EXTERNAL_VTK=ON
  )
  cmake "${cmake_options[@]}"
  cmake --build build
}

package() {
  DESTDIR="$pkgdir" cmake --install build

  # byte-compile python modules since the CMake build does not do it.
  local site_packages=$(python -c "import site; print(site.getsitepackages()[0])")
  python -m compileall -o 0 -o 1 -o 2 --hardlink-dupes -s "${pkgdir}" "${pkgdir}"${site_packages}
}

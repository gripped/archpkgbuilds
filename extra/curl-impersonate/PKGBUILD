# Maintainer: George Rawlinson <grawlinson@archlinux.org>

pkgname=curl-impersonate
pkgver=1.4.4
pkgrel=1
pkgdesc='A build of curl that impersonates four major browsers: Chrome, Edge, Safari & Firefox'
arch=(x86_64)
url='https://github.com/lexiforest/curl-impersonate'
license=(MIT)
depends=(
  glibc
  libgcc
  libstdc++
  bash
)
makedepends=(
  git
  cmake
  go
  ninja
  unzip
  chrpath
)
_brotli_version=1.2.0
_boringssl_commit=673e61fc215b178a90c0e67858bbf162c8158993
_nghttp2_version=1.63.0
_ngtcp2_version=1.11.0
_nghttp3_version=1.9.0
_curl_version=curl-8_15_0
_zlib_version=1.3.1
_zstd_version=1.5.6
_libunistring_version=1.1
_libidn2_version=2.3.7
source=(
  "$pkgname::git+$url#tag=v$pkgver"
  "brotli-${_brotli_version}.tar.gz::https://github.com/google/brotli/archive/refs/tags/v${_brotli_version}.tar.gz"
  "boringssl-${_boringssl_commit}.zip::https://github.com/google/boringssl/archive/${_boringssl_commit}.zip"
  "nghttp2-${_nghttp2_version}.tar.bz2::https://github.com/nghttp2/nghttp2/releases/download/v${_nghttp2_version}/nghttp2-${_nghttp2_version}.tar.bz2"
  "ngtcp2-${_ngtcp2_version}.tar.bz2::https://github.com/ngtcp2/ngtcp2/releases/download/v${_ngtcp2_version}/ngtcp2-${_ngtcp2_version}.tar.bz2"
  "nghttp3-${_nghttp3_version}.tar.bz2::https://github.com/ngtcp2/nghttp3/releases/download/v${_nghttp3_version}/nghttp3-${_nghttp3_version}.tar.bz2"
  "${_curl_version}.tar.gz::https://github.com/curl/curl/archive/${_curl_version}.tar.gz"
  "zlib-${_zlib_version}.tar.gz::https://github.com/madler/zlib/releases/download/v${_zlib_version}/zlib-${_zlib_version}.tar.gz"
  "zstd-${_zstd_version}.tar.gz::https://github.com/facebook/zstd/releases/download/v${_zstd_version}/zstd-${_zstd_version}.tar.gz"
  "libunistring-${_libunistring_version}.tar.gz::https://ftp.gnu.org/gnu/libunistring/libunistring-${_libunistring_version}.tar.gz"
  "libidn2-${_libidn2_version}.tar.gz::https://ftp.gnu.org/gnu/libidn/libidn2-${_libidn2_version}.tar.gz"
  no-download.patch
)
sha512sums=('62f19a155789b04fefa665ad193f46f7287f620817cb426311f3c38a7289ce48926c30d0d87d0dd600933f446965727a12a8f940a14ac8e01b92522e14ac7d75'
            'f94542afd2ecd96cc41fd21a805a3da314281ae558c10650f3e6d9ca732b8425bba8fde312823f0a564c7de3993bdaab5b43378edab65ebb798cefb6fd702256'
            'cb542c349ab6f51451de6fbe20483690965bdb36eb315970b3d1faf3d64968863e5fb59fb6cd2fc945126668fd526f4976077b13b03590ac32b1ca100ed1ee35'
            'a328b4642c6ca4395adfcaaf4e6eb6dbd39fa7bd86f872a76260af59a5a830e0ff5ad015865d6bc00e0baa8e4d0d9a67b4b97e9d78e5e05d1c53522364e5e235'
            '77cb2a098f29d2e4c1a0d32e1e2170b211e68f47e32bf304ab155d1184cbe0e5eb6e5e7d5f6b0eae19b03aec9f897194c04a6bc3f2b6f940b51a47c2ccb81a8e'
            '7eaeb124576eefea7c45b74eab96878f7e958fdc640e81d5aa5437e5240a7812ac28be1c4e5baa68f0d1e3ea7c6e877f7bb871f1abaa2acad89fed837c55856f'
            'd4a560e225d0110133f44ed57cf5394c1710530c5fec395d02baafaac9ea2186dd543047ae27fd7542894b8744070760516ae611602105b1b40605abbf84e684'
            '580677aad97093829090d4b605ac81c50327e74a6c2de0b85dd2e8525553f3ddde17556ea46f8f007f89e435493c9a20bc997d1ef1c1c2c23274528e3c46b94f'
            '54a578f2484da0520a6e9a24f501b9540a3fe3806785d6bc9db79fc095b7c142a7c121387c7eecd460ca71446603584ef1ba4d29a33ca90873338c9ffbd04f14'
            '9cb1acc8b39096f30e77ad2f4c6127c3ff01588dbf41389ff294e9b89616d54d6a76cad5748f8dcb70b78ec28100fc1272d4eb9e6527b52e89a1ecac25b43647'
            'eab5702bc0baed45492f8dde43a4d2ea3560ad80645e5f9e0cfa8d3b57bccd7fd782d04638e000ba07924a5d9f85e760095b55189188c4017b94705bef9b4a66'
            '968204bf21de0e530d01d1181e313885c6c6af1516252f534a20547813703bb2bc5d71d86f87821c9287793b0397843fcd371ee30f2f2fe1df91e564b9eb4033')
b2sums=('5c264d4984e0afcc6fd118b214df3a3a1f161d3fba08fed1187ea5efc7f037409b43c94e6c1f2d98631fb91abb4a1a45807d51aacba75a8f575587821d73590a'
        'e38ea35f4abe47b2113ccc0778bb7b0be77dcf4d26ce248347ecc4cfdea7ba40d17e0b175cad6f82055d07b1ec9976ffea649f59065866db2c36116c77e59824'
        'e31b039f0161bb2ad50b62ea588c319b4cbb7bf3cab59dafcf40f88defc2f27d42744edb88b04e2ce97789a81fefd6657601024811bf38e3ed1170f4920247a1'
        '8caab3602d79abe03f0b266feba07edbdcc95288824d41b39c672a74a9ef9c97e9421138eba4fc04c87aaaa0f26a7ce3779831825629f421f293481fa9f315e3'
        '0d1bc45fb79bc0de2c0292991586d92824a76c982624b6ef04e9394e0222deee6ed2726209950b3a16765f8c519c179e09962a68e8d89ba2377cef95d33239c7'
        '5fd1124061d57d9650f0cfb05a224f422853bde467c51bac8c379a3b5fdaf09e586fa59ce6d9d87ecfb263c858d4c1a2e42da8b2eb720e7f8d8fd4830bf1475f'
        '5f2d2e5f498495744e3b28ea375596f3e4213f32b5eb45ea9942c0339ad1541d0d98b1d4a774bfa4ce431fe23d81f860f4c150f325610d61286f2aea0a93f770'
        '872ef9cc41ba57e9809ab5714ffa15cc9d3ef6c4a948c57107f800fc373bcfe2475136407203cb9aa33b189994336f36f2757b7a582e065ad477bfd49260184b'
        'fe17cf0950f8ee2cc07bfa2b41e97f36a1832e396386cb94a55bede975dc974920578cf147b39eecbc5b53ff06fe0dc1fe781a4cab9bc9f767ea28c0e786422e'
        'c15e996aff5eb19f5f9f5c2358a4b86edb27f119c7bd40da78736ba05c971aca403fd8126a75449f0cb006bb7301dd22c442f254633a15368c5e1656a3f69ad4'
        '40fde88e6be1e4665738855608a65c949834728463a3fb466192403f1076e99f7d399b9631308ff6776a28915251a0136ddfe6a67e8e010c7ccdb7fc64125d39'
        '784a76400d0743c4fabdf641dd6eea2d1abb3319ae8ace903a72d37fd01a35518a26fce7a48b9ef75a0e2c33aaf0945963a802bfd1fa629dae9bad77902a5fd0')

prepare() {
  cd "$pkgname"

  # do not download dependencies
  patch -p1 -i "$srcdir/no-download.patch"

  # shuffle around dependencies to match folder structure expected in Makefile
  mv "$srcdir/brotli-${_brotli_version}" .
  mv "$srcdir/boringssl-${_boringssl_commit}" .
  mv "$srcdir/nghttp2-${_nghttp2_version}" .
  mv "$srcdir/ngtcp2-${_ngtcp2_version}" .
  mv "$srcdir/nghttp3-${_nghttp3_version}" .
  mv "$srcdir/curl-${_curl_version}" "${_curl_version}"
  mv "${srcdir}/zlib-${_zlib_version}" .
  mv "${srcdir}/zstd-${_zstd_version}" .
  mv "${srcdir}/libunistring-${_libunistring_version}" .
  mv "${srcdir}/libidn2-${_libidn2_version}" .

  autoreconf -vfi
}

build() {
  cd "$pkgname"

  ./configure --prefix=/usr

  make build -j1
}

package() {
  cd "$pkgname"

  make DESTDIR="$pkgdir" install

  # remove unnecessary files
  rm -rf "$pkgdir/usr/include"

  # remove unsafe rpath
  chrpath --delete \
    "$pkgdir/usr/lib/libcurl-impersonate.so" \
    "$pkgdir/usr/bin/curl-impersonate"

  # license
  install -vDm644 -t "$pkgdir/usr/share/licenses/$pkgname" LICENSE
}

# Maintainer: Alexander F. RÃ¸dseth <xyproto@archlinux.org>

pkgname=wallutils
pkgver=5.14.1
pkgrel=1
pkgdesc='Utilities for handling resolutions, wallpapers and timed wallpapers'
arch=(x86_64)
url='https://github.com/xyproto/wallutils'
license=(BSD-3-Clause)
options=(!strip !lto)
depends=(bash glibc libheif libx11 wayland)
makedepends=(git go libxcursor libxmu libxpm upx xbitmaps xorgproto)
optdepends=('feh: for setting the wallpaper for some window managers that runs under X'
            'imagemagick: for supporting HEIF/HEIC (macOS wallpaper) files'
            'nvidia-utils: for the vram utility'
            'procps-ng: for the Labwc window manager'
            'swaybg: for the Sway and Labwc window managers')
source=("git+$url#tag=v$pkgver")
b2sums=('f8cec26c7a8c4e73bdbb1d36529860ffd200697652727140415d5a6ab8f8f3e2824ea83dd5720ad6198621e2c652d67efd539c74acd64ca64815a5abda7b991d')

build() {
  export CGO_CFLAGS="$CFLAGS -fcf-protection=full"
  export CGO_LDFLAGS="$LDFLAGS -fcf-protection=full -Wl,-z,shstk"
  export LDFLAGS="$(echo $LDFLAGS | sed 's/ -Wl//g;s/,--sort-common//')"
  make -C $pkgname
}

package() {
  DESTDIR="$pkgdir" LDFLAGS="$LDFLAGS" make -C $pkgname install install-man
  find "$pkgdir/usr/bin/" -executable -type f -not -name heic-install -exec \
    upx --best --lzma --no-progress --no-time -q {} >/dev/null \;
  install -Dm644 $pkgname/LICENSE "$pkgdir/usr/share/licenses/$pkgname/LICENSE"
}

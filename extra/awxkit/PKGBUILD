# Maintainer: BlackIkeEagle <ike DOT devolder AT gmail DOT com>

pkgname=awxkit
_pkgname=awx
_commit=6dc4a4508da011cfa15a187ec3fd919f033008ac
pkgver=24.5.0
pkgrel=1
pkgdesc="The official command line interface for Ansible AWX"
arch=('any')
url="https://github.com/ansible/awx"
license=('Apache')
depends=(
  'python'
  'python-pytest'  # unreferenced, required in awxkit/yaml_file.py
  'python-pyyaml'
  'python-requests'
  'python-setuptools'  # unreferenced, required in awxkit/cli/client.py
  'python-websocket-client'
)
makedepends=('git' 'python-build' 'python-installer' 'python-setuptools' 'python-setuptools-scm' 'python-wheel')
checkdepends=(
  'jq'
  'python-pytest'
  'python-cryptography'
  'python-websocket-client'
)
optdepends=(
  'jq: for formatting'
  'python-cryptography: for cryptography support'
)
options=(!emptydirs)
source=("${_pkgname}::git+https://github.com/ansible/${_pkgname}#tag=$_commit")
sha512sums=('45feaea5de0f54c72eeee1eafca8474ccfb4153551ec5f5f6da60e0ff51abb57c46b071f60bc17af4803db158da726ee7696ccd5e66e0a5df93907e1b42d7360')

build() {
    cd "${_pkgname}/${pkgname}"
    python -m build --wheel --no-isolation
}

check() {
    local deselected=(
      # Python 3.11 test failure https://github.com/ansible/awx/issues/13820
      --deselect test/cli/test_options.py::TestOptions::test_actions_with_primary_key
    )
    cd "${_pkgname}/${pkgname}"
    PYTHONPATH="$PYTHONPATH:." pytest -vv "${deselected[@]}"
}

package() {
    cd "${_pkgname}/${pkgname}"
    python -m installer --destdir="$pkgdir" dist/*.whl
}

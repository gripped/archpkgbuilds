# Maintainer: Sven-Hendrik Haase <svenstaro@archlinux.org>
# Contributor: spider-mario <spidermario@free.fr>
# Contributor: Olaf Leidinger <oleid@mescharet.de>
# Contributor: fabien Cellier <fabien.cellier@gmail.com>

pkgname=pocl
pkgver=7.1
pkgrel=3
pkgdesc="Portable OpenCL is an open-source implementation of OpenCL which can be easily adapted for new targets"
arch=('x86_64')
url="http://portablecl.org/"
license=('MIT')
source=("git+https://github.com/pocl/pocl#tag=v$pkgver")
depends=('clang20' 'hwloc' 'opencl-icd-loader')
makedepends=('llvm20' 'cmake' 'opencl-headers' 'ocl-icd' 'ninja' 'python' 'git' 'nvidia-utils' 'cuda' 'cudnn')
optdepends=('cuda: CUDA driver'
            'cudnn: CUDA driver')
sha512sums=('8bc47a9409d62e656aec0e74e9b4771c3d8353f223e25942048555712fd7620271541bc01783a4992656e73e616e34fbd7d77d870485edd1ea74fe0d20375967')

build() {
  cd "$pkgname"

  local cmake_options=(
      -GNinja
      -Bbuild
      -DCMAKE_INSTALL_PREFIX=/usr
      -DCMAKE_INSTALL_LIBDIR=lib
      -DCMAKE_BUILD_TYPE=Release
      -DKERNELLIB_HOST_CPU_VARIANTS=distro
      # Should be provided by opencl-headers, avoid conflict
      -DINSTALL_OPENCL_HEADERS=OFF
      -DENABLE_CUDA=ON
      -DENABLE_CUDNN=ON
      -DCUDA_TOOLKIT_ROOT_DIR=/opt/cuda
  )
  cmake "${cmake_options[@]}"
  ninja -C build
}

check() {
  cd "$pkgname"

  ninja -C build check
}

package() {
  cd "$pkgname"

  DESTDIR="$pkgdir"/ ninja -C build install
  install -v -Dm 644 -t "$pkgdir"/usr/share/licenses/"$pkgname" LICENSE
}

From 11a5b60a7f0324a819208439f5aa8c3aa5d7469b Mon Sep 17 00:00:00 2001
From: Jerry Casiano <JerryCasiano@gmail.com>
Date: Sat, 4 Feb 2023 21:28:45 -0500
Subject: [PATCH] - Fix build failures with newer Nautilus versions

---
 .../nautilus/font-manager-menu-provider.c     | 14 +++++
 extensions/nautilus/meson.build               | 55 +++++++++++++------
 2 files changed, 52 insertions(+), 17 deletions(-)

diff --git a/extensions/nautilus/font-manager-menu-provider.c b/extensions/nautilus/font-manager-menu-provider.c
index 34ed5eea..c97bacd0 100644
--- a/extensions/nautilus/font-manager-menu-provider.c
+++ b/extensions/nautilus/font-manager-menu-provider.c
@@ -48,7 +48,11 @@ struct _FontManagerMenuProvider
     GDBusConnection *connection;
 };
 
+#ifdef NAUTILUS_4
+static void font_manager_menu_provider_interface_init (NautilusMenuProviderInterface *iface);
+#else
 static void font_manager_menu_provider_interface_init (NautilusMenuProviderIface *iface);
+#endif
 
 G_DEFINE_DYNAMIC_TYPE_EXTENDED (FontManagerMenuProvider,
                                 font_manager_menu_provider,
@@ -105,7 +109,10 @@ on_install_selected (FontManagerMenuProvider *self, NautilusMenuItem *item)
 
 static GList *
 font_manager_menu_provider_get_file_items (NautilusMenuProvider *provider,
+#ifdef NAUTILUS_4
+#else
                                            G_GNUC_UNUSED GtkWidget *widget,
+#endif
                                            GList *filelist)
 {
     if (filelist == NULL)
@@ -175,7 +182,10 @@ font_manager_menu_provider_get_file_items (NautilusMenuProvider *provider,
 
 static GList *
 font_manager_menu_provider_get_background_items (G_GNUC_UNUSED NautilusMenuProvider *provider,
+#ifdef NAUTILUS_4
+#else
                                                  G_GNUC_UNUSED GtkWidget *widget,
+#endif
                                                  G_GNUC_UNUSED NautilusFileInfo *current_folder)
 {
     return NULL;
@@ -199,7 +209,11 @@ font_manager_menu_provider_class_finalize (G_GNUC_UNUSED FontManagerMenuProvider
 }
 
 static void
+#ifdef NAUTILUS_4
+font_manager_menu_provider_interface_init (NautilusMenuProviderInterface *iface)
+#else
 font_manager_menu_provider_interface_init (NautilusMenuProviderIface *iface)
+#endif
 {
     iface->get_file_items = font_manager_menu_provider_get_file_items;
     iface->get_background_items = font_manager_menu_provider_get_background_items;
diff --git a/extensions/nautilus/meson.build b/extensions/nautilus/meson.build
index 93d5a1fe..a5e68bfd 100644
--- a/extensions/nautilus/meson.build
+++ b/extensions/nautilus/meson.build
@@ -6,20 +6,41 @@ nautilus_info = '''
     For more information see https://wiki.gnome.org/Apps/Files
 '''
 
-nautilus = dependency('libnautilus-extension', not_found_message: nautilus_info)
-
-result = run_command(python, '-c', list_sources)
-nautilus_extension_sources = result.stdout().strip().split('\n')
-result = run_command(python, '-c', list_headers)
-nautilus_extension_headers = result.stdout().strip().split('\n')
-
-nautilus_extension_dir = join_paths(get_option('libdir'), 'nautilus', 'extensions-3.0')
-
-nautilus_font_manager = shared_module('nautilus-font-manager',
-                                      [nautilus_extension_sources, nautilus_extension_headers],
-                                      dependencies: [nautilus, base_deps],
-                                      link_with: libfontmanager,
-                                      name_prefix: '',
-                                      install: true,
-                                      install_dir: nautilus_extension_dir,
-                                      install_rpath: pkglib_dir)
+nautilus = dependency('libnautilus-extension', required: false)
+nautilus4 = dependency('libnautilus-extension-4', required: false)
+
+if nautilus.found() or nautilus4.found()
+
+    result = run_command(python, '-c', list_sources)
+    nautilus_extension_sources = result.stdout().strip().split('\n')
+    result = run_command(python, '-c', list_headers)
+    nautilus_extension_headers = result.stdout().strip().split('\n')
+
+    if nautilus.found()
+        args = []
+        nautilus_version = '3.0'
+        nautilus_deps = [nautilus, base_deps]
+    else
+        args = ['-DNAUTILUS_4']
+        nautilus_version = '4'
+        nautilus_deps = [nautilus4, base_deps]
+
+    endif
+
+    nautilus_extension_dir = join_paths(get_option('libdir'), 'nautilus', 'extensions-@0@'.format(nautilus_version))
+
+    nautilus_font_manager = shared_module('nautilus-font-manager',
+                                          [nautilus_extension_sources, nautilus_extension_headers],
+                                          dependencies: nautilus_deps,
+                                          c_args: args,
+                                          link_with: libfontmanager,
+                                          name_prefix: '',
+                                          install: true,
+                                          install_dir: nautilus_extension_dir,
+                                          install_rpath: pkglib_dir)
+
+else
+
+    message(nautilus_info)
+
+endif
